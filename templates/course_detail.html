{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.course_name }}{% endblock %}

{% block sidebar_menu %}
{% include 'components/sidebar_mahasiswa.html' %}
{% endblock %}

{% block content %}
<style>
    /* --- CSS PERBAIKAN RESPONSIVE SIDEBAR --- */
    /* Pada layar kecil (Mobile/Tablet), ubah Sidebar menjadi Off-Canvas (Tersembunyi) */
    @media (max-width: 1024px) {
        aside {
            position: fixed !important;
            top: 0; left: 0; bottom: 0;
            z-index: 9999 !important; /* Prioritas TERTINGGI agar di atas backdrop */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            background-color: #1A1D24 !important;
            width: 280px !important;
            box-shadow: 4px 0 15px rgba(0,0,0,0.5);
        }
        
        aside.open {
            transform: translateX(0); /* Munculkan sidebar */
        }

        /* Backdrop gelap saat sidebar terbuka */
        #mobile-backdrop {
            display: none;
            position: fixed; inset: 0; 
            z-index: 9998 !important; /* Di bawah sidebar (9999), tapi di atas konten lain */
            background: rgba(0,0,0,0.6); /* Gelap transparan TANPA BLUR */
            backdrop-filter: none !important; /* Memastikan tidak ada efek blur */
        }
        #mobile-backdrop.show { display: block; }
    }
</style>

{# Backdrop untuk menutup sidebar di mobile (klik di area gelap) #}
<div id="mobile-backdrop" onclick="toggleSidebar()"></div>

{# Tambahkan class overflow-x-hidden untuk mencegah scroll horizontal tidak sengaja di Android #}
<div class="min-h-screen bg-[#0F1115] relative pb-20 overflow-x-hidden font-poppins">

    {# HERO BACKGROUND #}
    {# Tinggi dikurangi menjadi h-[250px] pada mobile agar tidak terlalu mendominasi #}
    <div class="absolute top-0 left-0 w-full h-[250px] md:h-[400px] z-0 pointer-events-none">
        <div class="absolute inset-0 bg-gradient-to-r from-indigo-900/40 to-purple-900/40"></div>
        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-[#0F1115]/80 to-[#0F1115]"></div>
    </div>

    <div class="relative z-10 px-4 py-6 md:p-8 lg:p-10 max-w-7xl mx-auto">

        {# HEADER NAVIGASI #}
        <div class="flex justify-between items-center mb-6 md:mb-8">
            <a href="{% url 'course_catalog' %}" class="inline-flex items-center text-gray-400 hover:text-white text-xs font-bold uppercase tracking-widest transition-colors group bg-[#1A1D24]/50 backdrop-blur-md px-3 py-2 rounded-full border border-white/5">
                <div class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center mr-2 group-hover:bg-indigo-600 transition-colors">
                    <i data-feather="arrow-left" class="w-3 h-3"></i>
                </div>
                Kembali
            </a>
            
            {# Tombol Hamburger Mobile #}
            <button onclick="toggleSidebar()" class="lg:hidden p-2 bg-[#1A1D24]/50 backdrop-blur-md rounded-full text-white border border-white/5 shadow-lg active:scale-95 transition-transform">
                <i data-feather="menu" class="w-6 h-6"></i>
            </button>
        </div>

        {# --- MOBILE TITLE SECTION (Hanya Muncul di < XL) --- #}
        <div class="block xl:hidden mb-8 animate-fade-in-up">
            <span class="inline-block px-3 py-1 rounded-lg bg-indigo-500/20 text-indigo-400 border border-indigo-500/30 text-[10px] font-bold uppercase tracking-widest mb-3">
                Course Detail
            </span>
            <h1 class="text-3xl md:text-4xl font-black text-white mb-4 leading-tight tracking-tight">
                {{ course.course_name }}
            </h1>
            <div class="flex items-center gap-3 text-sm text-gray-400">
                <div class="flex items-center gap-2 bg-[#1A1D24] px-3 py-1.5 rounded-full border border-white/5">
                    <div class="w-5 h-5 rounded-full bg-indigo-600 flex items-center justify-center text-[9px] font-bold text-white">
                        {{ lecturer_name|slice:":1" }}
                    </div>
                    <span class="font-bold text-xs text-gray-300">{{ lecturer_name }}</span>
                </div>
            </div>
        </div>

        <div class="flex flex-col xl:flex-row gap-8 lg:gap-10 items-start">

            {# 1. KONTEN UTAMA (KIRI) #}
            <div class="flex-1 w-full min-w-0 order-2 xl:order-1">

                {# --- DESKTOP TITLE SECTION (Hanya Muncul di XL+) --- #}
                <div class="hidden xl:block mb-8">
                    <span class="inline-block px-3 py-1 rounded-lg bg-indigo-500/20 text-indigo-400 border border-indigo-500/30 text-[10px] font-bold uppercase tracking-widest mb-4">
                        Course Detail
                    </span>
                    <h1 class="text-3xl md:text-5xl font-black text-white mb-6 leading-tight break-words tracking-tight">
                        {{ course.course_name }}
                    </h1>
                    <div class="flex flex-wrap items-center gap-6 text-sm text-gray-400">
                        <div class="flex items-center gap-2 bg-[#1A1D24] px-3 py-1.5 rounded-full border border-white/5">
                            <div class="w-6 h-6 rounded-full bg-indigo-600 flex items-center justify-center text-[10px] font-bold text-white flex-shrink-0">
                                {{ lecturer_name|slice:":1" }}
                            </div>
                            <span class="font-bold text-gray-300">{{ lecturer_name }}</span>
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1.5">
                            <i data-feather="layers" class="w-4 h-4 text-indigo-400"></i>
                            <span>{{ modules.count }} Modul</span>
                        </div>
                    </div>
                </div>

                {# DESKRIPSI #}
                <div class="prose prose-invert prose-sm md:prose-base text-gray-400 max-w-none leading-relaxed border-b border-white/5 pb-8 mb-8">
                    {{ course.description|linebreaks|default:"Belum ada deskripsi." }}
                </div>

                {# SILABUS #}
                <div>
                    <h3 class="text-xl md:text-2xl font-bold text-white mb-6 flex items-center gap-3">
                        <span class="w-8 h-8 rounded-lg bg-indigo-500/10 flex items-center justify-center border border-indigo-500/20 text-indigo-400">
                            <i data-feather="list" class="w-4 h-4"></i>
                        </span>
                        Silabus Materi
                    </h3>

                    <div class="space-y-3">
                        {% for mod in modules %}
                        <div class="group flex items-center p-4 bg-[#1A1D24] rounded-xl border border-white/5 hover:border-indigo-500/30 hover:bg-[#20242C] transition-all duration-300 transform active:scale-[0.99]">
                            
                            <div class="w-10 h-10 rounded-lg bg-[#0F1115] flex items-center justify-center text-gray-500 font-bold mr-4 border border-white/5 group-hover:text-indigo-400 group-hover:border-indigo-500/20 transition-colors flex-shrink-0">
                                {{ forloop.counter }}
                            </div>

                            <div class="flex-1 min-w-0 pr-2">
                                <h4 class="text-sm md:text-base font-bold text-gray-200 group-hover:text-white transition-colors line-clamp-2 leading-snug">
                                    {{ mod.title }}
                                </h4>
                                <p class="text-[10px] md:text-xs text-gray-500 mt-1 line-clamp-1">
                                    {{ mod.description|striptags|default:"Klik untuk mulai belajar." }}
                                </p>
                            </div>

                            <div class="flex-shrink-0 self-center pl-2">
                                {% if is_enrolled %}
                                <a href="{% url 'detail_modul' mod.module_id %}" class="w-10 h-10 rounded-full bg-[#252A33] text-white flex items-center justify-center hover:bg-indigo-600 hover:shadow-lg hover:shadow-indigo-600/30 transition-all border border-white/5">
                                    <i data-feather="play" class="w-4 h-4 ml-0.5 fill-current"></i>
                                </a>
                                {% else %}
                                <div class="w-10 h-10 rounded-full bg-[#252A33]/50 flex items-center justify-center border border-white/5">
                                    <i data-feather="lock" class="w-4 h-4 text-gray-600"></i>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="p-8 text-center bg-[#1A1D24] rounded-xl border border-dashed border-white/10 text-gray-500">
                            <p class="text-sm">Belum ada materi yang diunggah.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# 2. ACTION CARD (KANAN) #}
            <div class="w-full md:w-80 xl:w-96 flex-shrink-0 order-1 xl:order-2 mx-auto xl:mx-0">
                
                <div class="bg-[#1A1D24] rounded-2xl border border-white/10 p-5 md:p-6 shadow-2xl xl:sticky xl:top-8 relative overflow-hidden">

                    <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-indigo-600/20 blur-[80px] rounded-full pointer-events-none"></div>

                    <div class="aspect-video bg-[#20242C] rounded-xl mb-6 relative overflow-hidden group shadow-lg border border-white/5">
                        <img src="https://images.unsplash.com/photo-1516321318423-f06f85e504b3?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=60"
                             alt="{{ course.course_name }}"
                             class="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-105 transition-all duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-[#1A1D24] via-transparent to-transparent opacity-60"></div>

                        {% if is_enrolled %}
                        <div class="absolute top-3 right-3 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg flex items-center gap-1">
                            <i data-feather="check" class="w-3 h-3"></i> TERDAFTAR
                        </div>
                        {% endif %}
                    </div>

                    {% if is_enrolled %}
                    <div class="space-y-4 relative z-10">
                        {% if resume_module_id %}
                        <a href="{% url 'detail_modul' resume_module_id %}" class="flex items-center justify-center w-full py-4 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-sm shadow-lg shadow-indigo-600/20 transition-all active:scale-95 group">
                            <span class="mr-2">Lanjutkan Belajar</span>
                            <i data-feather="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                        </a>
                        {% else %}
                        <button disabled class="w-full py-4 rounded-xl bg-[#252A33] text-gray-500 font-bold text-sm cursor-not-allowed border border-white/5">
                            Belum ada modul aktif
                        </button>
                        {% endif %}

                        <div class="pt-2">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>Progress</span>
                                <span>0%</span>
                            </div>
                            <div class="w-full h-1.5 bg-[#252A33] rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500 w-0"></div> </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="space-y-4 relative z-10">
                        <div class="text-center mb-6">
                            <h4 class="text-white font-bold text-lg">Tertarik belajar?</h4>
                            <p class="text-gray-400 text-xs mt-1">Akses penuh ke semua materi selamanya.</p>
                        </div>
                        <form action="{% url 'enroll_course' course.course_id %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="flex items-center justify-center w-full py-4 rounded-xl bg-white text-black font-bold text-sm hover:bg-gray-200 transition-all shadow-lg transform active:scale-95 group">
                                <i data-feather="unlock" class="w-4 h-4 mr-2 text-indigo-600 group-hover:scale-110 transition-transform"></i>
                                Daftar Kelas Ini
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    
    // --- FUNGSI TOGGLE SIDEBAR ---
    // Fungsi ini memanggil <aside> dari base.html dan menambahkan class .open
    function toggleSidebar() {
        const sidebar = document.querySelector('aside');
        const backdrop = document.getElementById('mobile-backdrop');
        
        if(sidebar) {
            sidebar.classList.toggle('open');
            // Toggle backdrop visibility
            if(backdrop) {
                backdrop.classList.toggle('show');
            }
        }
    }
</script>

<style>
    .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}