{% extends 'base.html' %}
{% load static %}

{% block title %}Chat | Khacademy{% endblock %}

{# --- Tambahkan Logic Sidebar --- #}
{% block sidebar_menu %}
{% if request.session.role_name == 'Dosen' %}
{% include 'components/sidebar_dosen.html' %}
{% else %}
{% include 'components/sidebar_mahasiswa.html' %}
{% endif %}
{% endblock %}

{% block content %}
<style>
  /* CSS Mobile Sidebar (Sama seperti halaman lain) */
  @media (max-width: 1024px) {
    aside {
      position: fixed !important;
      top: 0; left: 0; bottom: 0;
      z-index: 9999 !important;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      background-color: #1A1D24 !important;
      width: 280px !important;
      box-shadow: 4px 0 15px rgba(0,0,0,0.5);
    }
    aside.open { transform: translateX(0); }
    #mobile-backdrop {
      display: none;
      position: fixed; inset: 0; z-index: 9998 !important;
      background: rgba(0,0,0,0.6);
    }
    #mobile-backdrop.show { display: block; }
  }

  /* Scrollbar Gelap */
  .custom-scroll::-webkit-scrollbar { width: 5px; }
  .custom-scroll::-webkit-scrollbar-track { background: #0F1115; }
  .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
</style>

<div id="mobile-backdrop" onclick="toggleSidebar()"></div>

<div class="h-screen bg-[#0F1115] p-4 lg:p-6 flex flex-col">

  {# --- WRAPPER UTAMA --- #}
  <div class="flex flex-1 gap-0 lg:gap-6 bg-[#1A1D24] rounded-[2rem] border border-white/5 shadow-2xl overflow-hidden relative">

    {# --- SIDEBAR KONTAK (KIRI) --- #}
    <div class="w-full md:w-80 bg-[#16181D] border-r border-white/5 flex flex-col md:flex">
      <div class="p-5 border-b border-white/5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          {# Tombol Hamburger (Mobile Only) #}
          <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-white">
            <i data-feather="menu" class="w-6 h-6"></i>
          </button>
          <h2 class="font-bold text-lg text-white">Pesan</h2>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto custom-scroll">
        {% for u in users %}
        <button onclick="loadChat('{{ u.user_id }}', '{{ u.name }}')" class="w-full text-left p-4 hover:bg-[#252A33] border-b border-white/5 flex items-center transition-colors group">
          <div class="w-10 h-10 rounded-full bg-[#252A33] flex items-center justify-center font-bold text-indigo-400 border border-white/10 mr-3 shrink-0 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
            {{ u.name|slice:":1" }}
          </div>
          <div class="overflow-hidden min-w-0">
            <p class="font-bold text-sm text-gray-200 truncate group-hover:text-white">{{ u.name }}</p>
            <p class="text-xs text-gray-500 truncate">{{ u.role.role_name }}</p>
          </div>
        </button>
        {% empty %}
        <div class="p-6 text-center text-gray-500 text-sm">Tidak ada kontak.</div>
        {% endfor %}
      </div>
    </div>

    {# --- AREA CHAT (KANAN) --- #}
    <div class="flex-1 flex flex-col bg-[#1A1D24] relative hidden md:flex" id="chat-area">

      {# Header Chat #}
      <div class="p-4 border-b border-white/5 bg-[#1A1D24] z-10 shadow-sm flex items-center">
        {# Tombol Back (Mobile Only, jika diperlukan logic mobile chat view) #}
        <button class="md:hidden mr-3 text-gray-400" onclick="showContactList()"><i data-feather="arrow-left"></i></button>
        <h3 class="font-bold text-white text-lg" id="chat-header">Pilih kontak untuk memulai</h3>
      </div>

      {# Chat Box #}
      <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#0F1115] custom-scroll">
        <div class="flex h-full items-center justify-center text-gray-500 flex-col opacity-50">
          <i data-feather="message-square" class="w-12 h-12 mb-3"></i>
          <p>Belum ada pesan dipilih.</p>
        </div>
      </div>

      {# Input Area #}
      <div class="p-4 bg-[#1A1D24] border-t border-white/5">
        <form onsubmit="sendMessage(event)" class="flex gap-3">
          <input type="hidden" id="receiver-id">
          <input type="text" id="msg-input"
                 class="flex-1 bg-[#0F1115] border border-white/10 rounded-xl px-5 py-3 text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder-gray-600"
                 placeholder="Tulis pesan..." disabled autocomplete="off">
          <button type="submit" id="send-btn" class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-500 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i data-feather="send" class="w-5 h-5"></i>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  feather.replace();

  // -- Toggle Sidebar Utama --
  function toggleSidebar() {
    const sidebar = document.querySelector('aside');
    const backdrop = document.getElementById('mobile-backdrop');
    if(sidebar) { sidebar.classList.toggle('open'); backdrop.classList.toggle('show'); }
  }

  // -- Logic Chat --
  let currentChatUserId = null;
  let chatInterval = null;

  async function loadChat(userId, userName) {
    currentChatUserId = userId;
    document.getElementById('chat-header').innerText = userName;
    document.getElementById('receiver-id').value = userId;

    const input = document.getElementById('msg-input');
    const btn = document.getElementById('send-btn');
    input.disabled = false;
    btn.disabled = false;
    input.focus();

    // Mobile UX: Tampilkan area chat, sembunyikan list kontak (jika di mobile)
    const chatArea = document.getElementById('chat-area');
    chatArea.classList.remove('hidden');
    chatArea.classList.add('flex');

    fetchMessages();
    if (chatInterval) clearInterval(chatInterval);
    chatInterval = setInterval(fetchMessages, 3000);
  }

  async function fetchMessages() {
    if (!currentChatUserId) return;
    const box = document.getElementById('chat-box');
    try {
      // Sesuaikan endpoint AJAX Anda di sini
      const response = await fetch(`/ajax/get-chat/${currentChatUserId}/`);
      const data = await response.json();

      if(data.status === 'success') {
        box.innerHTML = '';
        if (data.messages.length === 0) {
          box.innerHTML = '<div class="flex h-full items-center justify-center text-gray-500 text-xs"><p>Belum ada riwayat pesan.</p></div>';
        }

        data.messages.forEach(msg => {
          const div = document.createElement('div');
          div.className = `flex ${msg.is_me ? 'justify-end' : 'justify-start'} animate-fade-in`;
          // Bubble Chat Dark Mode
          const bgClass = msg.is_me ? 'bg-indigo-600 text-white rounded-br-sm' : 'bg-[#252A33] border border-white/5 text-gray-200 rounded-bl-sm';

          div.innerHTML = `
                        <div class="max-w-[75%] px-4 py-3 rounded-2xl text-sm ${bgClass} shadow-sm">
                            <p class="whitespace-pre-wrap leading-relaxed">${msg.text}</p>
                            <p class="text-[10px] opacity-60 mt-1 text-right font-mono">${msg.time}</p>
                        </div>
                    `;
          box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
      }
    } catch (e) { console.error(e); }
  }

  async function sendMessage(e) {
    e.preventDefault();
    const input = document.getElementById('msg-input');
    const text = input.value;
    const receiverId = document.getElementById('receiver-id').value;

    if(!text.trim()) return;

    const form = new FormData();
    form.append('receiver_id', receiverId);
    form.append('message', text);
    form.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    // Optimistic UI Update
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.className = 'flex justify-end animate-fade-in';
    div.innerHTML = `
            <div class="max-w-[75%] px-4 py-3 rounded-2xl text-sm bg-indigo-600 text-white rounded-br-sm shadow-sm">
                <p class="whitespace-pre-wrap leading-relaxed">${text}</p>
                <p class="text-[10px] opacity-60 mt-1 text-right font-mono">Baru saja</p>
            </div>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    input.value = '';

    await fetch('/ajax/send-message/', { method: 'POST', body: form });
    setTimeout(fetchMessages, 500);
  }

  // Helper Animation Style
  const style = document.createElement('style');
  style.innerHTML = `.animate-fade-in { animation: fadeIn 0.3s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }`;
  document.head.appendChild(style);
</script>
{% endblock %}