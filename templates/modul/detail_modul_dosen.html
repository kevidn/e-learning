{% extends 'base.html' %}
{% load static %}

{% block title %}Kelola: {{ module.title }} | Modern Dark{% endblock %}

{# Reuse sidebar dosen #}
{% block sidebar_menu %}
    {% include 'components/sidebar_dosen.html' %}
{% endblock %}

{% block content %}
<div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-2 pointer-events-none"></div>

<div class="min-h-full bg-[#0F1115] p-6 lg:p-10 text-white font-poppins">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
        <div class="flex-1 w-full">
            <a href="{% url 'list_modul' %}" class="inline-flex items-center text-gray-500 hover:text-white text-xs font-bold mb-4 uppercase tracking-widest transition-colors group">
                <div class="p-1.5 bg-[#1A1D24] rounded-lg mr-2 border border-white/5 group-hover:border-white/20 transition-all">
                    <i data-feather="arrow-left" class="w-3 h-3"></i>
                </div>
                Daftar Modul
            </a>

            <div class="group relative">
                <div id="title-display" class="flex items-center gap-3">
                    <h1 class="text-3xl md:text-4xl font-black text-white tracking-tight leading-tight" id="title-text">
                        {{ module.title }}
                    </h1>
                    <button onclick="toggleEdit('title', true)" class="p-2 rounded-xl bg-[#1A1D24] text-gray-400 hover:text-white hover:bg-[#252A33] border border-white/5 opacity-0 group-hover:opacity-100 transition-all transform hover:scale-105">
                        <i data-feather="edit-2" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <form id="title-form" class="hidden w-full max-w-2xl" onsubmit="saveChanges(event, 'title')">
                    {% csrf_token %}
                    <div class="flex gap-2">
                        <input type="text" name="title" id="input-title" value="{{ module.title }}" 
                               class="flex-1 px-4 py-3 bg-[#1A1D24] border border-indigo-500/50 rounded-xl text-2xl font-bold text-white outline-none focus:ring-2 focus:ring-indigo-500/20 shadow-xl">
                        <button type="submit" class="px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 transition-colors shadow-lg">
                            <i data-feather="check"></i>
                        </button>
                        <button type="button" onclick="toggleEdit('title', false)" class="px-4 bg-[#252A33] text-gray-300 rounded-xl hover:bg-[#333] border border-white/5">
                            <i data-feather="x"></i>
                        </button>
                    </div>
                </form>

                <div class="flex items-center gap-3 mt-3 text-sm text-gray-400">
                    <span class="flex items-center gap-1.5 bg-[#1A1D24] px-3 py-1 rounded-lg border border-white/5">
                        <i data-feather="book" class="w-3 h-3 text-indigo-400"></i>
                        {{ module.course.course_name }}
                    </span>
                    <span class="flex items-center gap-1.5 bg-[#1A1D24] px-3 py-1 rounded-lg border border-white/5">
                        <i data-feather="calendar" class="w-3 h-3 text-gray-500"></i>
                        {{ module.created_at|date:"d M Y" }}
                    </span>
                </div>
            </div>
        </div>

        <button onclick="openContentModal()" class="flex-shrink-0 bg-white text-black px-6 py-3.5 rounded-xl font-bold hover:bg-gray-200 transition-all shadow-[0_0_20px_rgba(255,255,255,0.15)] flex items-center transform hover:-translate-y-0.5">
            <i data-feather="plus" class="w-5 h-5 mr-2"></i> Tambah Materi
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-8">
            
            <div class="bg-[#1A1D24] rounded-[2rem] border border-white/5 p-8 relative group overflow-hidden">
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i data-feather="align-left" class="w-5 h-5 text-gray-400"></i> Deskripsi
                    </h3>
                    <button onclick="toggleEdit('description', true)" class="text-xs font-bold text-indigo-400 hover:text-indigo-300 bg-indigo-500/10 px-3 py-1.5 rounded-lg border border-indigo-500/20 transition-colors">Edit</button>
                </div>
                
                <div id="description-display" class="text-gray-400 leading-relaxed relative z-10">
                    {{ module.description|linebreaks|default:"<span class='italic opacity-50'>Belum ada deskripsi.</span>" }}
                </div>
                
                <div id="description-form" class="hidden relative z-10">
                    <form onsubmit="saveChanges(event, 'description')">
                        {% csrf_token %}
                        <textarea name="description" id="input-description" rows="4" 
                                  class="w-full bg-[#0F1115] border border-indigo-500/50 rounded-xl p-4 text-gray-200 outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all resize-none shadow-inner">{{ module.description }}</textarea>
                        <div class="flex gap-2 justify-end mt-3">
                            <button type="button" onclick="toggleEdit('description', false)" class="px-4 py-2 text-xs font-bold text-gray-400 hover:text-white">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-white text-black text-xs font-bold rounded-lg hover:bg-gray-200 shadow-lg">Simpan</button>
                        </div>
                    </form>
                </div>

                <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
            </div>

            <div>
                <h3 class="text-xl font-bold text-white mb-5 flex items-center gap-3">
                    <span class="bg-[#1A1D24] p-2 rounded-xl border border-white/5 text-gray-400"><i data-feather="layers" class="w-5 h-5"></i></span>
                    Materi Pembelajaran
                </h3>
                
                <div id="content-list" class="space-y-4 min-h-[100px]">
                    {% for content in contents %}
                    <div id="content-card-{{ content.content_id }}" class="content-item bg-[#1A1D24] rounded-[1.5rem] border border-white/5 p-1 relative group hover:border-white/10 transition-all shadow-lg" data-id="{{ content.content_id }}">
                        
                        <div class="p-5 flex items-start gap-4 relative z-10">
                            <div class="drag-handle cursor-move p-2 text-gray-600 hover:text-white hover:bg-[#252A33] rounded-lg transition-colors mt-1">
                                <i data-feather="move" class="w-5 h-5"></i>
                            </div>

                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center bg-[#20242C] border border-white/5 flex-shrink-0 text-indigo-400 group-hover:text-white group-hover:bg-indigo-600 transition-all duration-300 shadow-inner">
                                <i data-feather="{% if content.video_url %}play-circle{% else %}file-text{% endif %}" class="w-6 h-6"></i>
                            </div>

                            <div class="flex-1 min-w-0 pt-0.5">
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="text-lg font-bold text-white title-display truncate pr-4">{{ content.title }}</h4>
                                    
                                    <div class="flex gap-2 opacity-40 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openEditContentModal('{{ content.content_id }}', '{{ content.title|escapejs }}', `{{ content.text_content|escapejs }}`, '{{ content.video_url|default:'' }}')" 
                                                class="p-2 rounded-lg bg-[#252A33] text-gray-400 hover:text-white hover:bg-indigo-600 transition-all shadow-sm" title="Edit">
                                            <i data-feather="edit-3" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="triggerDeleteContent('{{ content.content_id }}')" 
                                                class="p-2 rounded-lg bg-[#252A33] text-gray-400 hover:text-white hover:bg-red-600 transition-all shadow-sm" title="Hapus">
                                            <i data-feather="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="content-body text-sm text-gray-500 line-clamp-1 group-hover:text-gray-400 transition-colors">
                                    {{ content.text_content|striptags|default:"Konten Video" }}
                                </div>
                            </div>
                        </div>

                        <div id="quiz-wrapper-{{ content.content_id }}" class="bg-[#20242C]/50 border-t border-white/5 px-6 py-4 rounded-b-[1.5rem] pl-[4.5rem]">
                            {% if content.quiz %}
                                <div class="flex justify-between items-center bg-[#252A33] p-3 rounded-xl border border-white/5 hover:border-indigo-500/30 transition-all shadow-sm group/quiz">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-purple-500/10 text-purple-400 rounded-lg border border-purple-500/20">
                                            <i data-feather="help-circle" class="w-4 h-4"></i>
                                        </div>
                                        <div>
                                            <p class="font-bold text-white text-sm flex items-center gap-2">
                                                {{ content.quiz.title }}
                                                <span class="text-[9px] px-1.5 py-0.5 bg-purple-500/20 text-purple-300 rounded border border-purple-500/30">QUIZ</span>
                                            </p>
                                            <p class="text-[10px] text-gray-500 font-mono mt-0.5">{{ content.quiz.questions.count }} Questions</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 opacity-60 group-hover/quiz:opacity-100 transition-opacity">
                                        <button onclick="openGradeModal('quiz', '{{ content.quiz.quiz_id }}')" class="p-1.5 bg-[#1A1D24] text-green-400 rounded-lg hover:bg-green-600 hover:text-white transition-all border border-white/5" title="Lihat Nilai">
                                            <i data-feather="users" class="w-3.5 h-3.5"></i>
                                        </button>
                                        <button onclick="editQuizAJAX('{{ content.quiz.quiz_id }}', '{{ content.content_id }}', '{{ content.title|escapejs }}')" class="p-1.5 bg-[#1A1D24] text-indigo-400 rounded-lg hover:bg-indigo-600 hover:text-white transition-all border border-white/5" title="Edit">
                                            <i data-feather="edit-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                        <button onclick="triggerDeleteQuiz('{{ content.quiz.quiz_id }}', '{{ content.content_id }}', '{{ content.title|escapejs }}')" class="p-1.5 bg-[#1A1D24] text-red-400 rounded-lg hover:bg-red-600 hover:text-white transition-all border border-white/5" title="Hapus">
                                            <i data-feather="trash" class="w-3.5 h-3.5"></i>
                                        </button>
                                    </div>
                                </div>
                            {% else %}
                                <button onclick="openQuizModal('{{ content.content_id }}', '{{ content.title|escapejs }}')" class="w-full py-2.5 border border-dashed border-white/10 rounded-xl text-xs font-bold text-gray-500 hover:text-white hover:bg-[#252A33] hover:border-indigo-500/50 transition-all flex items-center justify-center gap-2">
                                    <i data-feather="plus-circle" class="w-3.5 h-3.5"></i> Tambah Kuis
                                </button>
                            {% endif %}
                        </div>

                    </div>
                    {% empty %}
                    <div class="text-center py-24 bg-[#1A1D24] rounded-[2rem] border border-dashed border-white/10 flex flex-col items-center justify-center">
                        <div class="w-16 h-16 bg-[#252A33] rounded-full flex items-center justify-center text-gray-600 mb-4">
                            <i data-feather="layers" class="w-8 h-8"></i>
                        </div>
                        <p class="text-gray-400 font-medium">Belum ada materi.</p>
                        <button onclick="openContentModal()" class="text-indigo-400 text-sm font-bold hover:underline mt-2">Mulai Tambahkan</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="space-y-8">
            
            <div class="bg-[#1A1D24] rounded-[2.5rem] border border-white/5 overflow-hidden shadow-xl">
                <div class="p-6 bg-gradient-to-r from-orange-900/20 to-red-900/20 border-b border-white/5 flex justify-between items-center">
                    <h4 class="font-bold text-orange-400 flex items-center gap-2">
                        <i data-feather="clipboard" class="w-4 h-4"></i> Tugas
                    </h4>
                    <button onclick="openTaskModal()" class="bg-white text-black px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-200 shadow-lg transform hover:scale-105 transition-all flex items-center gap-1">
                        <i data-feather="plus" class="w-3 h-3"></i> Buat
                    </button>
                </div>
                
                <div class="p-5 space-y-3 max-h-[500px] overflow-y-auto custom-scroll">
                    {% for assign in assignments %}
                    <div id="task-item-{{ assign.assignment_id }}" class="bg-[#20242C] p-4 rounded-2xl border border-white/5 group hover:border-orange-500/30 hover:bg-[#252932] transition-all relative">
                        
                        <div class="flex justify-between items-start mb-2">
                            <p class="font-bold text-white text-sm task-title-disp leading-tight pr-8">{{ assign.title }}</p>
                            <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openGradeModal('assignment', '{{ assign.assignment_id }}')" class="p-1.5 bg-[#1A1D24] text-green-400 rounded-lg hover:bg-green-600 hover:text-white border border-white/5 shadow-sm" title="Nilai">
                                    <i data-feather="check-square" class="w-3 h-3"></i>
                                </button>
                                <button onclick="editTaskAJAX('{{ assign.assignment_id }}')" class="p-1.5 bg-[#1A1D24] text-indigo-400 rounded-lg hover:bg-indigo-600 hover:text-white border border-white/5 shadow-sm" title="Edit">
                                    <i data-feather="edit-2" class="w-3 h-3"></i>
                                </button>
                                <button onclick="triggerDeleteTask('{{ assign.assignment_id }}')" class="p-1.5 bg-[#1A1D24] text-red-400 rounded-lg hover:bg-red-600 hover:text-white border border-white/5 shadow-sm" title="Hapus">
                                    <i data-feather="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 text-xs text-gray-500 task-deadline-disp mt-3 bg-[#1A1D24] w-fit px-2 py-1 rounded-lg border border-white/5">
                            <i data-feather="clock" class="w-3 h-3 text-orange-400"></i> {{ assign.deadline|date:"d M, H:i" }}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 opacity-50">
                        <i data-feather="clipboard" class="w-8 h-8 text-gray-600 mx-auto mb-2"></i>
                        <p class="text-xs text-gray-500">Tidak ada tugas.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-[#1A1D24] rounded-[2rem] border border-white/5 p-6 text-center">
                <p class="text-xs text-gray-500 mb-4">Tindakan Berbahaya</p>
                <button onclick="triggerDeleteModule()" class="w-full py-3.5 rounded-xl bg-red-500/10 text-red-500 font-bold hover:bg-red-600 hover:text-white transition-all flex items-center justify-center gap-2 border border-red-500/20">
                    <i data-feather="trash-2" class="w-4 h-4"></i> Hapus Modul Ini
                </button>
                <form id="form-hapus-modul" method="POST" action="{% url 'hapus_modul' module.module_id %}" class="hidden">{% csrf_token %}</form>
            </div>

        </div>
    </div>
</div>

<div id="contentModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeContentModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-[#1A1D24] rounded-3xl w-full max-w-2xl border border-white/10 shadow-2xl transform transition-all scale-100 relative my-auto">
            
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-black text-white tracking-tight" id="contentModalTitle">Materi Baru</h3>
                    <p class="text-gray-500 text-xs mt-1">Isi detail konten pembelajaran.</p>
                </div>
                <button onclick="closeContentModal()" class="text-gray-500 hover:text-white hover:bg-white/10 p-2 rounded-lg transition-colors"><i data-feather="x"></i></button>
            </div>
            
            <form id="contentForm" class="p-8 space-y-6">
                {% csrf_token %}
                <input type="hidden" name="module_id" value="{{ module.module_id }}">
                <input type="hidden" name="content_id" id="modal-content-id">
                
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Judul Materi</label>
                    <input type="text" name="title" id="c_title" required 
                           class="w-full bg-[#0F1115] border border-white/10 rounded-xl px-5 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all placeholder-gray-700"
                           placeholder="Judul topik...">
                </div>
                
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Isi Teks</label>
                    <textarea name="text_content" id="c_text" rows="6" 
                              class="w-full bg-[#0F1115] border border-white/10 rounded-xl px-5 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all placeholder-gray-700 resize-none custom-scroll"
                              placeholder="Tulis materi pembelajaran di sini..."></textarea>
                </div>
                
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Link Video (Opsional)</label>
                    <div class="relative">
                        <i data-feather="youtube" class="absolute left-4 top-3.5 w-5 h-5 text-gray-600"></i>
                        <input type="url" name="video_url" id="c_video" 
                               class="w-full bg-[#0F1115] border border-white/10 rounded-xl pl-12 pr-5 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all placeholder-gray-700"
                               placeholder="https://youtube.com/...">
                    </div>
                    <p class="text-[10px] text-gray-500 ml-1">*Link YouTube akan otomatis di-embed.</p>
                </div>
                
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeContentModal()" class="px-6 py-3 rounded-xl bg-transparent text-gray-400 font-bold text-sm hover:bg-white/5 transition-colors">Batal</button>
                    <button type="submit" class="btn-save-content px-8 py-3 bg-white text-black font-bold text-sm rounded-xl hover:bg-gray-200 shadow-lg transform hover:-translate-y-0.5 transition-all flex items-center">
                        <i data-feather="check" class="w-4 h-4 mr-2"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeQuizModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-[#1A1D24] rounded-3xl w-full max-w-3xl border border-white/10 shadow-2xl flex flex-col max-h-[90vh] relative my-auto">
            
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-[#1A1D24]">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-purple-500/10 rounded-lg text-purple-400"><i data-feather="help-circle" class="w-6 h-6"></i></div>
                    <div>
                        <h3 class="text-lg font-black text-white" id="quiz-parent-title">...</h3>
                        <p class="text-xs text-gray-500">Setup pertanyaan dan kunci jawaban.</p>
                    </div>
                </div>
                <button onclick="closeQuizModal()" class="text-gray-500 hover:text-white p-2 hover:bg-white/10 rounded-lg"><i data-feather="x"></i></button>
            </div>
            
            <form id="quizForm" class="flex flex-col flex-1 overflow-hidden">
                {% csrf_token %}
                <input type="hidden" name="content_id" id="modal-quiz-content-id">
                <input type="hidden" name="quiz_id" id="modal-quiz-id">
                
                <div class="p-8 overflow-y-auto custom-scroll space-y-8 flex-1 bg-[#0F1115]">
                    <div class="grid grid-cols-1 gap-6 p-6 bg-[#1A1D24] rounded-2xl border border-white/5">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Judul Kuis</label>
                            <input type="text" name="title" id="quiz-title" required 
                                   class="w-full bg-[#0F1115] border border-white/10 rounded-xl px-4 py-2.5 text-white focus:border-purple-500 outline-none" placeholder="Contoh: Evaluasi Bab 1">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Deskripsi</label>
                            <input type="text" name="description" id="quiz-desc" 
                                   class="w-full bg-[#0F1115] border border-white/10 rounded-xl px-4 py-2.5 text-white focus:border-purple-500 outline-none" placeholder="Opsional...">
                        </div>
                    </div>

                    <div id="questions-container" class="space-y-6"></div>

                    <button type="button" onclick="addQuestionField()" class="w-full py-4 border-2 border-dashed border-white/10 rounded-2xl text-gray-400 font-bold hover:border-purple-500/50 hover:text-purple-400 hover:bg-[#1A1D24] transition-all flex items-center justify-center gap-2 group">
                        <i data-feather="plus-circle" class="w-5 h-5 group-hover:scale-110 transition-transform"></i> Tambah Pertanyaan Baru
                    </button>
                </div>

                <div class="p-5 border-t border-white/5 bg-[#1A1D24] flex justify-end gap-3">
                    <button type="button" onclick="closeQuizModal()" class="px-6 py-2.5 rounded-xl text-gray-400 font-bold hover:text-white hover:bg-white/5">Batal</button>
                    <button type="submit" class="btn-save-quiz px-8 py-2.5 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-500 shadow-lg">Simpan Kuis</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="taskModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="closeTaskModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-[#1A1D24] rounded-3xl w-full max-w-lg border border-white/10 shadow-2xl">
            <div class="p-6 bg-gradient-to-r from-orange-900/40 to-red-900/40 border-b border-white/5 flex justify-between items-center rounded-t-3xl">
                <h3 class="text-lg font-black text-white flex items-center gap-2">
                    <i data-feather="clipboard" class="text-orange-400"></i> <span id="task-modal-title">Tugas Baru</span>
                </h3>
                <button onclick="closeTaskModal()" class="text-gray-400 hover:text-white"><i data-feather="x"></i></button>
            </div>
            
            <form id="taskForm" class="p-8 space-y-5">
                {% csrf_token %}
                <input type="hidden" name="module_id" value="{{ module.module_id }}">
                <input type="hidden" name="task_id" id="modal-task-id">
                
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Judul Tugas</label>
                    <input type="text" name="title" id="task-title" required 
                           class="w-full bg-[#0F1115] border border-white/10 rounded-xl px-4 py-3 text-white focus:border-orange-500 outline-none">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Instruksi</label>
                    <textarea name="description" id="task-desc" rows="3" 
                              class="w-full bg-[#0F1115] border border-white/10 rounded-xl px-4 py-3 text-white focus:border-orange-500 outline-none resize-none"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Deadline</label>
                    <input type="datetime-local" name="deadline" id="task-deadline" required 
                           class="w-full bg-[#0F1115] border border-white/10 rounded-xl px-4 py-3 text-white focus:border-orange-500 outline-none appearance-none scheme-dark">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">File Pendukung</label>
                    <input type="file" name="files" multiple 
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-[#0F1115] file:text-orange-400 hover:file:bg-[#20242C] cursor-pointer border border-white/10 rounded-xl">
                </div>
                
                <div class="pt-4 flex justify-end">
                    <button type="submit" class="btn-save-task w-full py-3.5 bg-white text-black font-bold rounded-xl hover:bg-gray-200 shadow-lg">Simpan Tugas</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="gradeModal" class="fixed inset-0 z-[70] hidden">
    <div class="fixed inset-0 bg-black/90 backdrop-blur-md" onclick="closeGradeModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-[#1A1D24] rounded-3xl w-full max-w-5xl h-[85vh] border border-white/10 shadow-2xl flex flex-col overflow-hidden">
            
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-[#16181D]">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-green-500/10 rounded-xl text-green-400 border border-green-500/20">
                        <i data-feather="check-square" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black text-white">Penilaian Mahasiswa</h3>
                        <p class="text-green-400 text-xs font-bold mt-0.5 uppercase tracking-wider" id="grade-modal-subtitle">Memuat data...</p>
                    </div>
                </div>
                <button onclick="closeGradeModal()" class="p-2 bg-[#0F1115] rounded-lg text-gray-400 hover:text-white transition-colors"><i data-feather="x"></i></button>
            </div>

            <div class="flex-1 overflow-auto bg-[#0F1115] p-6" id="grade-list-container">
                <div class="flex flex-col items-center justify-center h-64 text-gray-500 animate-pulse">
                    <i data-feather="loader" class="w-10 h-10 mb-4 animate-spin"></i>
                    <p class="font-medium">Mengambil data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Scrollbar Dark */
    .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #0F1115; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #555; }
    
    /* Date Input Dark Mode Fix */
    input[type="datetime-local"]::-webkit-calendar-picker-indicator {
        filter: invert(1); opacity: 0.5; cursor: pointer;
    }
    
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    feather.replace();
    
    // --- SETUP VARIABLES ---
    let currentModuleId = {{ module.module_id }};
    const urlTemplateEdit = "{% url 'edit_modul' 0 %}";
    const urlTemplateHapusKonten = "{% url 'hapus_konten' 0 %}";
    const reorderUrl = "{% url 'reorder_konten' %}";
    const urlCreateContent = "{% url 'create_content_ajax' %}";
    const urlUpdateContent = "{% url 'update_content_ajax' %}";
    const urlCreateQuizAjax = "{% url 'create_quiz_ajax' %}";
    const urlUpdateQuizAjax = "{% url 'update_quiz_ajax' %}";
    const urlGetQuizTemplate = "{% url 'get_quiz_data' 0 %}";
    const urlCreateTaskAjax = "{% url 'create_task_ajax' %}";
    const urlGetTask = "{% url 'get_task_data' 0 %}";
    const urlUpdateTask = "{% url 'update_task_ajax' %}";
    const urlDeleteTask = "{% url 'delete_task_ajax' 0 %}";
    const urlGetGrades = "/ajax/get-grades/TYPE/ID/"; 
    const urlUpdateGrade = "{% url 'update_grade_ajax' %}";

    // --- DRAG & DROP SORTABLE ---
    const listContainer = document.getElementById('content-list');
    if (listContainer) {
        new Sortable(listContainer, {
            handle: '.drag-handle', animation: 150, ghostClass: 'opacity-50',
            scroll: true, scrollSensitivity: 100, scrollSpeed: 20,
            onEnd: function () { saveOrder(); }
        });
    }

    // --- CONTENT MODAL LOGIC ---
    function openContentModal() {
        document.getElementById('contentForm').reset();
        document.getElementById('modal-content-id').value = "";
        document.getElementById('contentModalTitle').innerText = "Tambah Materi Baru";
        document.getElementById('contentModal').classList.remove('hidden');
    }
    function openEditContentModal(id, title, text, video) {
        document.getElementById('contentForm').reset();
        document.getElementById('modal-content-id').value = id;
        document.getElementById('c_title').value = title;
        document.getElementById('c_text').value = text;
        document.getElementById('c_video').value = video;
        document.getElementById('contentModalTitle').innerText = "Edit Materi";
        document.getElementById('contentModal').classList.remove('hidden');
    }
    function closeContentModal() { document.getElementById('contentModal').classList.add('hidden'); }

    // --- CONTENT SUBMIT (AJAX) ---
    document.getElementById('contentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('.btn-save-content');
        const oldText = btn.innerHTML; btn.innerHTML = 'Menyimpan...'; btn.disabled = true;
        
        const formData = new FormData(this);
        const contentId = document.getElementById('modal-content-id').value;
        const targetUrl = contentId ? urlUpdateContent : urlCreateContent;

        try {
            const res = await fetch(targetUrl, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' }});
            const data = await res.json();
            if (data.status === 'success') { window.location.reload(); } // Reload simple solution for now
            else showToast(data.message, 'error');
        } catch (e) { console.error(e); showToast('Error server', 'error'); }
        finally { btn.innerHTML = oldText; btn.disabled = false; }
    });

    // --- QUIZ MODAL LOGIC ---
    let questionCount = 0;
    function openQuizModal(contentId, contentTitle) {
        document.getElementById('quizForm').reset();
        document.getElementById('modal-quiz-content-id').value = contentId;
        document.getElementById('modal-quiz-id').value = "";
        document.getElementById('quiz-parent-title').innerText = "Buat Kuis Baru";
        document.getElementById('questions-container').innerHTML = ''; 
        questionCount = 0; addQuestionField();
        document.getElementById('quizModal').classList.remove('hidden');
    }
    
    async function editQuizAJAX(quizId, contentId, contentTitle) {
        const url = urlGetQuizTemplate.replace('0', quizId);
        try {
            const res = await fetch(url);
            const data = await res.json();
            if(data.status === 'success') {
                document.getElementById('modal-quiz-id').value = data.quiz_id;
                document.getElementById('modal-quiz-content-id').value = contentId;
                document.getElementById('quiz-title').value = data.title;
                document.getElementById('quiz-desc').value = data.description;
                document.getElementById('quiz-parent-title').innerText = "Edit Kuis";
                document.getElementById('questions-container').innerHTML = ''; 
                questionCount = 0;
                if (data.questions.length > 0) data.questions.forEach(q => addQuestionField(q.text, q.a, q.b, q.c, q.d, q.correct));
                else addQuestionField();
                document.getElementById('quizModal').classList.remove('hidden');
            }
        } catch (e) {}
    }
    function closeQuizModal() { document.getElementById('quizModal').classList.add('hidden'); }

    function addQuestionField(text='', a='', b='', c='', d='', correct='A') {
        questionCount++;
        const container = document.getElementById('questions-container');
        const div = document.createElement('div');
        div.className = "bg-[#16181D] p-6 rounded-2xl border border-white/5 relative group animate-fade-in";
        const isSel = (val) => val === correct ? 'selected' : '';

        div.innerHTML = `
            <div class="absolute top-4 right-4 cursor-pointer text-gray-600 hover:text-red-500 transition-colors" onclick="this.parentElement.remove()">
                <i data-feather="trash" class="w-4 h-4"></i>
            </div>
            <p class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-3">Pertanyaan ${questionCount}</p>
            <div class="mb-4">
                <textarea name="q_text[]" required placeholder="Tulis pertanyaan di sini..." class="w-full bg-[#0F1115] border border-white/10 rounded-xl p-3 text-white focus:border-indigo-500 outline-none text-sm">${text}</textarea>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input type="text" name="opt_a[]" value="${a}" required placeholder="Opsi A" class="bg-[#0F1115] border border-white/10 rounded-xl p-3 text-white text-sm focus:border-indigo-500 outline-none">
                <input type="text" name="opt_b[]" value="${b}" required placeholder="Opsi B" class="bg-[#0F1115] border border-white/10 rounded-xl p-3 text-white text-sm focus:border-indigo-500 outline-none">
                <input type="text" name="opt_c[]" value="${c}" required placeholder="Opsi C" class="bg-[#0F1115] border border-white/10 rounded-xl p-3 text-white text-sm focus:border-indigo-500 outline-none">
                <input type="text" name="opt_d[]" value="${d}" required placeholder="Opsi D" class="bg-[#0F1115] border border-white/10 rounded-xl p-3 text-white text-sm focus:border-indigo-500 outline-none">
            </div>
            <div class="flex items-center gap-3 bg-[#0F1115] p-3 rounded-xl border border-white/5 w-fit">
                <label class="text-xs font-bold text-gray-500 uppercase">Kunci Jawaban:</label>
                <select name="correct_answer[]" class="bg-transparent text-white font-bold outline-none cursor-pointer">
                    <option class="bg-[#1A1D24]" value="A" ${isSel('A')}>A</option>
                    <option class="bg-[#1A1D24]" value="B" ${isSel('B')}>B</option>
                    <option class="bg-[#1A1D24]" value="C" ${isSel('C')}>C</option>
                    <option class="bg-[#1A1D24]" value="D" ${isSel('D')}>D</option>
                </select>
            </div>`;
        container.appendChild(div); feather.replace();
    }

    document.getElementById('quizForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('.btn-save-quiz');
        btn.disabled = true; btn.innerText = 'Menyimpan...';
        const formData = new FormData(this);
        const quizId = document.getElementById('modal-quiz-id').value;
        const targetUrl = quizId ? urlUpdateQuizAjax : urlCreateQuizAjax;
        
        try {
            const res = await fetch(targetUrl, { method:'POST', body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} });
            const data = await res.json();
            if(data.status === 'success') { window.location.reload(); }
            else showToast(data.message, 'error');
        } catch(e) {} finally { btn.disabled = false; }
    });

    // --- DELETE QUIZ (MODAL) ---
    function triggerDeleteQuiz(qid, cid, title) {
        openDeleteModal(() => executeDeleteQuiz(qid), "Hapus Kuis?", `Yakin menghapus kuis pada "${title}"?`);
    }
    async function executeDeleteQuiz(qid) {
        const url = "{% url 'hapus_quiz' 0 %}".replace('0', qid);
        try {
            const res = await fetch(url, { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}'} });
            if ((await res.json()).status === 'success') window.location.reload();
        } catch(e) {}
    }

    // --- TASK MODAL LOGIC ---
    function openTaskModal() {
        document.getElementById('taskForm').reset();
        document.getElementById('modal-task-id').value = "";
        document.getElementById('task-modal-title').innerText = "Tugas Baru";
        document.getElementById('taskModal').classList.remove('hidden');
    }
    async function editTaskAJAX(taskId) {
        const url = urlGetTask.replace('0', taskId);
        try {
            const res = await fetch(url); const data = await res.json();
            if(data.status === 'success') {
                document.getElementById('modal-task-id').value = data.task_id;
                document.getElementById('task-title').value = data.title;
                document.getElementById('task-desc').value = data.description;
                document.getElementById('task-deadline').value = data.deadline;
                document.getElementById('task-modal-title').innerText = "Edit Tugas";
                document.getElementById('taskModal').classList.remove('hidden');
            }
        } catch(e){}
    }
    function closeTaskModal() { document.getElementById('taskModal').classList.add('hidden'); }

    document.getElementById('taskForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('.btn-save-task'); btn.disabled = true; btn.innerText = '...';
        const formData = new FormData(this);
        const taskId = document.getElementById('modal-task-id').value;
        const targetUrl = taskId ? urlUpdateTask : urlCreateTaskAjax;
        try {
            const res = await fetch(targetUrl, { method:'POST', body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} });
            if ((await res.json()).status === 'success') window.location.reload();
        } catch(e){} finally { btn.disabled = false; }
    });
    
    function triggerDeleteTask(tid) {
        openDeleteModal(() => executeDeleteTask(tid), "Hapus Tugas?", "Tugas akan dihapus permanen.");
    }
    async function executeDeleteTask(tid) {
        const url = urlDeleteTask.replace('0', tid);
        try {
            const res = await fetch(url, { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken':'{{ csrf_token }}'} });
            if((await res.json()).status === 'success') window.location.reload();
        } catch(e){}
    }

    // --- GRADE MODAL (TABEL PENILAIAN MODERN) ---
    function openGradeModal(type, id) {
        const modal = document.getElementById('gradeModal');
        const container = document.getElementById('grade-list-container');
        const subtitle = document.getElementById('grade-modal-subtitle');
        modal.classList.remove('hidden');
        subtitle.innerText = "Mengambil data...";
        
        container.innerHTML = `<div class="flex h-full items-center justify-center text-gray-500"><i data-feather="loader" class="w-8 h-8 animate-spin"></i></div>`; feather.replace();

        const url = urlGetGrades.replace('TYPE', type).replace('ID', id);
        fetch(url).then(res => res.json()).then(data => {
            if(data.status === 'success') {
                subtitle.innerText = `${type === 'assignment' ? 'Tugas' : 'Kuis'}: ${data.title}`;
                renderGradeList(data.students, type, id);
            } else container.innerHTML = `<p class="text-red-500 text-center py-10">${data.message}</p>`;
        }).catch(e => container.innerHTML = `<p class="text-red-500 text-center py-10">Error koneksi.</p>`);
    }
    function closeGradeModal() { document.getElementById('gradeModal').classList.add('hidden'); }

    function renderGradeList(students, type, itemId) {
        const container = document.getElementById('grade-list-container');
        if(students.length === 0) {
            container.innerHTML = `<div class="text-center py-20 text-gray-500">Belum ada mahasiswa di kelas ini.</div>`; return;
        }

        let html = `
            <table class="w-full text-left border-separate border-spacing-y-2">
                <thead class="text-xs font-bold text-gray-500 uppercase tracking-widest">
                    <tr>
                        <th class="px-4 py-2">Mahasiswa</th>
                        <th class="px-4 py-2">Status</th>
                        <th class="px-4 py-2 w-1/3">Feedback</th>
                        <th class="px-4 py-2 text-right">Nilai</th>
                    </tr>
                </thead>
                <tbody>
        `;

        students.forEach(s => {
            const isDone = s.status === 'Diserahkan' || s.status === 'Selesai';
            const badgeClass = isDone ? 'bg-green-500/10 text-green-400 border-green-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20';
            const fileBtn = s.file_url ? `<a href="${s.file_url}" target="_blank" class="ml-2 text-indigo-400 hover:text-white text-xs underline">File <i data-feather="external-link" class="w-3 h-3 inline"></i></a>` : '';
            
            html += `
                <tr class="bg-[#1A1D24] hover:bg-[#20242C] transition-colors group rounded-xl">
                    <td class="px-4 py-4 rounded-l-xl border-l border-y border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-xs">${s.avatar}</div>
                            <div>
                                <p class="text-sm font-bold text-white">${s.name}</p>
                                <p class="text-[10px] text-gray-500">ID: ${s.student_id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 border-y border-white/5 align-middle">
                        <span class="px-2 py-1 rounded-md text-[10px] font-bold border uppercase ${badgeClass}">${s.status}</span>
                        ${fileBtn}
                        <div class="text-[10px] text-gray-500 mt-1 font-mono">${s.submitted_at || '-'}</div>
                    </td>
                    <td class="px-4 py-4 border-y border-white/5 align-middle">
                        <input type="text" id="feedback-${s.student_id}" value="${s.feedback || ''}" 
                               class="w-full bg-[#0F1115] border border-white/10 rounded-lg px-3 py-2 text-xs text-white focus:border-indigo-500 outline-none transition-all placeholder-gray-700"
                               placeholder="Beri catatan..." onchange="saveGrade('${s.student_id}', '${type}', '${itemId}')">
                    </td>
                    <td class="px-4 py-4 rounded-r-xl border-r border-y border-white/5 align-middle text-right">
                        <div class="flex items-center justify-end gap-2">
                            <input type="number" id="score-${s.student_id}" value="${s.score}" min="0" max="100"
                                   class="w-16 bg-[#0F1115] border border-white/10 rounded-lg px-2 py-2 text-center font-bold text-white focus:border-green-500 outline-none"
                                   onchange="saveGrade('${s.student_id}', '${type}', '${itemId}')">
                            <div id="indicator-${s.student_id}" class="w-4"></div>
                        </div>
                    </td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        container.innerHTML = html; feather.replace();
    }

    async function saveGrade(sid, type, iid) {
        const scoreIn = document.getElementById(`score-${sid}`);
        const feedIn = document.getElementById(`feedback-${sid}`);
        const ind = document.getElementById(`indicator-${sid}`);
        
        ind.innerHTML = `<div class="w-3 h-3 border-2 border-white/20 border-t-white rounded-full animate-spin"></div>`;
        
        const formData = new FormData();
        formData.append('student_id', sid); formData.append('type', type);
        formData.append('item_id', iid); formData.append('score', scoreIn.value);
        formData.append('feedback', feedIn.value);

        try {
            const res = await fetch(urlUpdateGrade, { method:'POST', body:formData, headers:{'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken':'{{ csrf_token }}'} });
            if ((await res.json()).status === 'success') {
                ind.innerHTML = `<i data-feather="check" class="w-3 h-3 text-green-500"></i>`; feather.replace();
                setTimeout(() => ind.innerHTML = '', 2000);
            } else {
                ind.innerHTML = `<i data-feather="x" class="w-3 h-3 text-red-500"></i>`; feather.replace();
                showToast('Gagal simpan', 'error');
            }
        } catch(e) { ind.innerHTML = ''; }
    }

    // --- HELPERS ---
    async function saveChanges(event, section) {
        event.preventDefault();
        const form = event.target; // Perbaikan: ambil form dari event target langsung
        // Karena form tidak punya ID spesifik saat di-submit lewat onsubmit="...", kita pakai FormData(form)
        
        // Khusus title/description form toggle logic
        const formData = new FormData(form);
        
        try {
            const res = await fetch(urlTemplateEdit.replace('0', currentModuleId), { 
                method:'POST', body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} 
            });
            const data = await res.json();
            if(data.status === 'success') {
                if(section === 'title') document.getElementById('title-text').innerText = data.new_title;
                else document.getElementById('description-display').innerHTML = data.new_description.replace(/\n/g, '<br>'); // Simple line break
                
                toggleEdit(section, false);
                showToast('Berhasil disimpan', 'success');
            }
        } catch(e){}
    }

    function toggleEdit(section, show) {
        const disp = document.getElementById(`${section}-display`);
        const form = document.getElementById(`${section}-form`);
        // Khusus Title, karena displaynya flex kompleks, kita toggle class hidden di parent container jika perlu
        // Tapi di HTML baru, kita toggle elemennya langsung
        
        if(section === 'title') {
            // Logic khusus header title
             if(show) {
                document.getElementById('title-display').classList.add('hidden');
                document.getElementById('title-form').classList.remove('hidden');
            } else {
                document.getElementById('title-display').classList.remove('hidden');
                document.getElementById('title-form').classList.add('hidden');
            }
        } else {
            if(show) { disp.classList.add('hidden'); form.classList.remove('hidden'); }
            else { disp.classList.remove('hidden'); form.classList.add('hidden'); }
        }
    }

    async function saveOrder() {
        const ids = Array.from(document.querySelectorAll('.content-item')).map(el => el.dataset.id);
        await fetch(reorderUrl, { 
            method:'POST', 
            headers:{'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken':'{{ csrf_token }}'},
            body:JSON.stringify({ordered_ids:ids})
        });
    }

    async function triggerDeleteContent(cid) {
        openDeleteModal(() => executeDeleteContent(cid), "Hapus Materi?", "Materi ini akan dihapus permanen.");
    }
    async function executeDeleteContent(cid) {
        const res = await fetch(urlTemplateHapusKonten.replace('0', cid), { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken':'{{ csrf_token }}'} });
        if ((await res.json()).status === 'success') {
            document.getElementById(`content-card-${cid}`).remove();
            showToast('Terhapus', 'success');
        }
    }

    async function triggerDeleteModule() {
        openDeleteModal(() => document.getElementById('form-hapus-modul').submit(), "Hapus Modul?", "Seluruh konten & tugas akan hilang.");
    }

    // Modal Delete Helper
    let delCallback = null;
    function openDeleteModal(cb, title, desc) {
        delCallback = cb;
        document.getElementById('deleteModalTitle').innerText = title;
        document.getElementById('deleteModalDesc').innerText = desc;
        document.getElementById('deleteModal').classList.remove('hidden');
    }
    function closeDeleteModal() { document.getElementById('deleteModal').classList.add('hidden'); }
    document.getElementById('confirmDeleteBtn').addEventListener('click', () => { if(delCallback) delCallback(); closeDeleteModal(); });
    
    function showToast(msg, type) {
        const box = document.getElementById('toast-container');
        const el = document.createElement('div');
        const bg = type === 'success' ? 'bg-green-600' : 'bg-red-600';
        el.className = `${bg} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-2 transform transition-all duration-300 translate-x-full mb-2`;
        el.innerHTML = `<i data-feather="${type==='success'?'check':'alert-circle'}" class="w-4 h-4"></i> ${msg}`;
        box.appendChild(el); feather.replace();
        setTimeout(() => el.classList.remove('translate-x-full'), 10);
        setTimeout(() => el.remove(), 3000);
    }

    feather.replace();
</script>
{% endblock %}
{% endblock %}