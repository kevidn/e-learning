{% extends 'base.html' %}
{% load static %}

{% block title %}{{ module.title }} | Khacademy{% endblock %}

{# --- SEMBUNYIKAN SIDEBAR UTAMA & HEADER DEFAULT --- #}
{% block sidebar_menu %}{% endblock %}
{% block header_title %}{% endblock %}
{% block header_subtitle %}{% endblock %}
{% block navbar_actions %}{% endblock %}

{% block content %}
<style>
    /* Paksa sembunyikan sidebar base */
    aside.w-72 { display: none !important; }
    main { padding: 0 !important; max-height: 100vh; overflow: hidden; }

    .learning-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        height: 100vh;
        background-color: #0F1115;
    }

    /* Responsive Layout */
    @media (max-width: 1024px) {
        .learning-layout { grid-template-columns: 1fr; }

        /* Sidebar jadi Drawer di Mobile */
        .sidebar-materi {
            position: fixed;
            left: 0; top: 0; bottom: 0;
            width: 85%;
            max-width: 320px;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50; /* Di atas konten */
        }

        .sidebar-materi.show-sidebar {
            transform: translateX(0);
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }
    }

    /* Backdrop untuk mobile saat sidebar buka */
    .mobile-backdrop {
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(4px);
        z-index: 40;
        opacity: 0; pointer-events: none;
        transition: opacity 0.3s;
    }
    .mobile-backdrop.show { opacity: 1; pointer-events: auto; }
</style>

<div class="learning-layout font-poppins text-gray-200 relative">

    {# --- MOBILE BACKDROP --- #}
    <div id="mobile-backdrop" class="mobile-backdrop" onclick="toggleSidebar()"></div>

    {# --- KOLOM KIRI: DAFTAR MATERI --- #}
    <div id="sidebar-materi" class="sidebar-materi bg-[#16181D] border-r border-white/5 flex flex-col h-full z-50">
        <div class="p-6 border-b border-white/5">
            <div class="flex items-center justify-between mb-6">
                <a href="{% url 'my_learning' %}" class="flex items-center text-gray-400 hover:text-white transition-colors group">
                    <div class="p-1.5 bg-[#252A33] rounded-lg border border-white/5 group-hover:bg-white group-hover:text-black transition-all mr-3">
                        <i data-feather="arrow-left" class="w-4 h-4"></i>
                    </div>
                    <span class="text-xs font-bold uppercase tracking-widest">Kembali</span>
                </a>

                {# Tombol Close di Mobile #}
                <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-white">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <h2 class="text-xl font-bold text-white leading-tight mb-1">{{ module.title }}</h2>
            <p class="text-xs text-gray-500 font-medium">{{ contents.count }} Materi Pembelajaran</p>

            <div class="w-full bg-[#0F1115] rounded-full h-1.5 mt-4 overflow-hidden">
                <div class="bg-indigo-600 h-1.5 rounded-full" style="width: 0%" id="mini-progress-bar"></div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-1">
            {% for content in contents %}
            <button onclick="loadContent('{{ content.content_id }}', this); if(window.innerWidth < 1024) toggleSidebar();"
                    id="nav-item-{{ content.content_id }}"
                    class="w-full text-left p-3.5 flex items-start space-x-3 rounded-xl transition-all border border-transparent group relative
                {% if forloop.first %}bg-[#252A33] border-white/5 text-white active-item shadow-lg{% else %}hover:bg-white/5 text-gray-400 hover:text-gray-200{% endif %}">

                <div class="active-indicator absolute left-0 top-3 bottom-3 w-1 bg-indigo-500 rounded-r-full {% if not forloop.first %}hidden{% endif %}"></div>

                <div class="flex-shrink-0 mt-0.5 ml-1">
                    <i data-feather="{% if content.video_url %}play-circle{% else %}file-text{% endif %}"
                       class="w-4 h-4 icon-display {% if forloop.first %}text-indigo-400{% endif %}"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium truncate leading-snug">{{ content.title }}</h4>
                </div>
            </button>
            {% endfor %}
        </div>
    </div>

    {# --- KOLOM KANAN: KONTEN UTAMA --- #}
    <div class="flex-1 flex flex-col h-full bg-[#0F1115] relative overflow-hidden">

        {# Header Overlay: Toggle Mobile & Pengajar Info #}
        <div class="absolute top-0 left-0 right-0 p-4 md:p-6 flex justify-between items-start z-30 pointer-events-none">
            {# Tombol Hamburger Mobile #}
            <button onclick="toggleSidebar()" class="lg:hidden pointer-events-auto p-2 bg-[#1A1D24]/80 backdrop-blur-md rounded-lg border border-white/10 text-white shadow-lg">
                <i data-feather="menu" class="w-6 h-6"></i>
            </button>

            <div class="pointer-events-auto bg-[#1A1D24]/80 backdrop-blur-md px-4 py-2 rounded-full border border-white/5 flex items-center gap-3 shadow-xl ml-auto">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Pengajar</p>
                    <p class="text-xs font-bold text-white">{{ module.course.lecturer.name }}</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-xs">
                    {{ module.course.lecturer.name|slice:":1" }}
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 lg:p-12 pb-32 relative z-10" id="main-scroll-area">

            <div id="loading-overlay" class="hidden absolute inset-0 bg-[#0F1115] z-50 flex flex-col items-center justify-center min-h-[500px]">
                <div class="w-10 h-10 border-4 border-white/5 border-t-indigo-500 rounded-full animate-spin mb-4"></div>
                <p class="text-gray-500 text-sm font-medium animate-pulse">Memuat materi...</p>
            </div>

            <div id="dynamic-lesson-content" class="max-w-4xl mx-auto mt-14 md:mt-0">
                {% with first=contents|first %}
                {% if first %}
                <div class="animate-fade-in relative z-20">
                    <div class="mb-8 md:mb-10 pb-6 border-b border-white/5">
                        <span class="inline-block px-3 py-1 rounded-lg bg-indigo-500/10 text-indigo-400 text-[10px] font-bold uppercase tracking-widest border border-indigo-500/20 mb-4">
                            Topik Bahasan
                        </span>
                        <h1 class="text-2xl md:text-4xl font-black text-white leading-tight">{{ first.title }}</h1>
                    </div>

                    <div id="media-placeholder" class="mb-8 md:mb-12 relative z-20">
                        {% if first.video_url %}
                        <div class="relative w-full aspect-video bg-black rounded-2xl md:rounded-3xl overflow-hidden shadow-2xl border border-white/10 group ring-1 ring-white/5 z-20">
                            <iframe class="w-full h-full absolute inset-0"
                                    src="{{ first.get_embed_url }}?rel=0"
                                    title="{{ first.title }}"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    referrerpolicy="strict-origin-when-cross-origin"
                                    allowfullscreen>
                            </iframe>
                        </div>
                        {% endif %}
                    </div>

                    <div class="prose prose-invert prose-base md:prose-lg max-w-none text-gray-300 leading-relaxed relative z-20">
                        {{ first.text_content|linebreaks }}
                    </div>
                </div>
                {% else %}
                <div class="flex flex-col items-center justify-center h-[60vh] opacity-40">
                    <i data-feather="book-open" class="w-16 h-16 text-gray-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-400">Pilih materi untuk memulai</h3>
                </div>
                {% endif %}
                {% endwith %}
            </div>

            {# TUGAS SECTION (Sama, hanya penyesuaian padding mobile) #}
            {% if assignment %}
            <div class="mt-24 max-w-4xl mx-auto relative z-20">
                <div class="bg-[#16181D] border border-white/5 rounded-3xl p-6 md:p-8 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-600/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

                    <div class="relative z-10">
                        <div class="flex items-center mb-6">
                            <div class="p-3 bg-indigo-500/10 text-indigo-400 rounded-xl border border-indigo-500/20 mr-4">
                                <i data-feather="clipboard" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Tugas Modul</h3>
                                <p class="text-sm text-gray-500">Selesaikan tugas ini untuk menuntaskan modul</p>
                            </div>
                        </div>

                        <div class="bg-[#0F1115] rounded-2xl p-6 border border-white/5 mb-8">
                            <h4 class="font-bold text-white text-lg mb-2">{{ assignment.title }}</h4>
                            <p class="text-gray-400 text-sm leading-relaxed mb-4">{{ assignment.description|linebreaks }}</p>
                            <div class="flex items-center gap-2">
                                <i data-feather="clock" class="w-3 h-3 text-red-400"></i>
                                <span class="text-xs font-bold text-red-400 uppercase tracking-wide">Deadline: {{ assignment.deadline|date:"d M Y, H:i" }}</span>
                            </div>
                        </div>

                        {# Form Submission Logic (Tidak berubah, hanya styling wrapping) #}
                        {% if submission %}
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="flex-1 bg-green-500/5 border border-green-500/20 rounded-2xl p-6">
                                <div class="flex items-center text-green-400 font-bold mb-2">
                                    <i data-feather="check-circle" class="w-5 h-5 mr-2"></i> Status: Terkirim
                                </div>
                                <p class="text-xs text-gray-500 mb-4 font-mono">Pada: {{ submission.submitted_at|date:"d M Y, H:i" }}</p>

                                {% if submission.answer_text %}
                                <div class="p-4 bg-[#0F1115] rounded-xl border border-white/5 text-sm text-gray-300 italic mb-3 break-words">
                                    "{{ submission.answer_text }}"
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <form method="POST" enctype="multipart/form-data" class="space-y-6">
                            {% csrf_token %}
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Jawaban Anda</label>
                                <textarea name="answer_text" rows="4" class="w-full bg-[#0F1115] border border-white/10 rounded-xl px-5 py-3 text-white focus:border-indigo-500 outline-none transition-all placeholder-gray-700 resize-none" placeholder="Tulis jawaban di sini..."></textarea>
                            </div>

                            <div class="space-y-2">
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Upload File (Opsional)</label>
                                <input type="file" name="assignment_file" class="w-full text-sm text-gray-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-[#252A33] file:text-white hover:file:bg-indigo-600 transition-all cursor-pointer border border-white/10 rounded-xl">
                            </div>

                            <div class="flex justify-end">
                                <button type="submit" class="w-full md:w-auto px-8 py-3 bg-white text-black font-bold rounded-xl shadow-lg hover:bg-gray-200 transition-all flex items-center justify-center">
                                    Kirim Jawaban <i data-feather="send" class="w-4 h-4 ml-2"></i>
                                </button>
                            </div>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% endif %}

            {# --- NAVIGASI MODUL --- #}
            <div class="max-w-4xl mx-auto mt-16 mb-8 px-0 md:px-2">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">

                    {# Tombol Previous #}
                    {% if prev_module %}
                    <a href="{% url 'detail_modul' prev_module.module_id %}"
                       class="w-full md:w-auto flex items-center gap-4 px-6 py-4 rounded-2xl bg-[#1A1D24] border border-white/5 hover:border-white/10 hover:bg-[#20242C] transition-all group">
                        <div class="w-10 h-10 rounded-full bg-[#0F1115] flex items-center justify-center text-gray-400 group-hover:text-white transition-colors border border-white/5 flex-shrink-0">
                            <i data-feather="arrow-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                        </div>
                        <div class="text-left flex-1 min-w-0">
                            <span class="block text-[10px] uppercase font-bold tracking-widest text-gray-500 mb-0.5">Sebelumnya</span>
                            <span class="block text-sm font-bold text-gray-300 group-hover:text-white transition-colors truncate">
                                    {{ prev_module.title }}
                                </span>
                        </div>
                    </a>
                    {% else %}
                    <div class="hidden md:block"></div>
                    {% endif %}

                    {# Tombol Next #}
                    {% if next_module %}
                    <a href="{% url 'detail_modul' next_module.module_id %}"
                       class="w-full md:w-auto flex items-center justify-between md:justify-start gap-4 px-6 py-4 rounded-2xl bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-600/20 hover:-translate-y-1 transition-all group border border-indigo-500 ring-1 ring-white/10">
                        <div class="text-left md:text-right flex-1 min-w-0 order-2 md:order-1">
                            <span class="block text-[10px] uppercase font-bold tracking-widest text-indigo-200 mb-0.5">Selanjutnya</span>
                            <span class="block text-sm font-bold truncate">
                                    {{ next_module.title }}
                                </span>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white backdrop-blur-sm flex-shrink-0 order-1 md:order-2">
                            <i data-feather="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </a>
                    {% else %}
                    <a href="{% url 'my_learning' %}"
                       class="w-full md:w-auto flex items-center gap-4 px-6 py-4 rounded-2xl bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-600/20 hover:-translate-y-1 transition-all group">
                        <div class="text-right flex-1">
                            <span class="block text-[10px] uppercase font-bold tracking-widest text-green-200 mb-0.5">Selesai</span>
                            <span class="block text-sm font-bold">Kembali ke Dashboard</span>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white">
                            <i data-feather="check" class="w-4 h-4"></i>
                        </div>
                    </a>
                    {% endif %}

                </div>
            </div>

            <div class="h-32"></div>
        </div>

        {# CHAT BAR (Fix: Max-width & Sticky) #}
        <div class="absolute bottom-0 left-0 right-0 p-4 md:p-6 bg-gradient-to-t from-[#0F1115] via-[#0F1115] to-transparent pointer-events-none z-40">
            <div class="pointer-events-auto max-w-4xl mx-auto bg-[#1A1D24] border border-white/10 rounded-2xl p-2 shadow-2xl flex items-center gap-2">
                <form id="quick-chat-form" onsubmit="return false;" class="flex-1 flex gap-2">
                    {% csrf_token %}
                    <input type="hidden" name="course_id" value="{{ module.course.course_id }}">
                    <input type="hidden" id="lecturer-id" value="{{ module.course.lecturer.user_id }}">

                    <div class="relative hidden sm:block">
                        <select id="chat-destination" class="appearance-none bg-[#0F1115] text-gray-400 text-xs font-bold py-3 pl-4 pr-8 rounded-xl focus:outline-none cursor-pointer hover:text-white transition-colors border border-transparent hover:border-white/5 h-full">
                            <option value="public">@ Kelas</option>
                            {% if module.course.lecturer %}
                            <option value="private">@ Dosen</option>
                            {% endif %}
                        </select>
                    </div>

                    <input type="text" id="quick-message-input" name="message"
                           placeholder="Tanya ke forum..."
                           class="flex-1 bg-transparent border-none text-gray-200 text-sm focus:ring-0 placeholder-gray-600 px-2"
                           autocomplete="off" required>

                    <button type="submit" id="btn-quick-send" class="p-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl transition-all shadow-lg active:scale-95 flex-shrink-0">
                        <i data-feather="send" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>

    </div>
</div>

<style>
    .custom-scroll::-webkit-scrollbar { width: 5px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #555; }

    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block extra_js %}
<script>
    feather.replace();
    const urlSubmitQuiz = "{% url 'submit_quiz_ajax' %}";

    // --- New Toggle Function for Mobile ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar-materi');
        const backdrop = document.getElementById('mobile-backdrop');
        sidebar.classList.toggle('show-sidebar');
        backdrop.classList.toggle('show');
    }
    // --------------------------------------

    async function loadContent(contentId, btnElement) {
        // Reset Styles
        document.querySelectorAll('button[id^="nav-item-"]').forEach(btn => {
            btn.classList.remove('bg-[#252A33]', 'border-white/5', 'text-white', 'active-item', 'shadow-lg');
            btn.classList.add('text-gray-400', 'hover:bg-white/5', 'hover:text-gray-200');
            btn.querySelector('.active-indicator').classList.add('hidden');
            const icon = btn.querySelector('.icon-display');
            if(icon) icon.classList.remove('text-indigo-400');
        });

        if(btnElement) {
            btnElement.classList.remove('text-gray-400', 'hover:bg-white/5', 'hover:text-gray-200');
            btnElement.classList.add('bg-[#252A33]', 'border-white/5', 'text-white', 'active-item', 'shadow-lg');
            btnElement.querySelector('.active-indicator').classList.remove('hidden');
            const icon = btnElement.querySelector('.icon-display');
            if(icon) icon.classList.add('text-indigo-400');
        }

        const container = document.getElementById('dynamic-lesson-content');
        const loader = document.getElementById('loading-overlay');
        const scrollArea = document.getElementById('main-scroll-area');

        container.innerHTML = ''; // Clear content
        loader.classList.remove('hidden');

        try {
            const response = await fetch(`/api/content/${contentId}/`);
            if (!response.ok) throw new Error('Gagal ambil data');
            const data = await response.json();

            // Responsive Font Sizes in render
            let htmlContent = `
                <div class="animate-fade-in relative z-20">
                    <div class="mb-8 md:mb-10 pb-6 border-b border-white/5">
                        <span class="inline-block px-3 py-1 rounded-lg bg-indigo-500/10 text-indigo-400 text-[10px] font-bold uppercase tracking-widest border border-indigo-500/20 mb-4">
                            Topik Bahasan
                        </span>
                        <h1 class="text-2xl md:text-4xl font-black text-white leading-tight">${data.title}</h1>
                    </div>`;

            if (data.video_url) {
                const embedUrl = data.video_url.includes('?') ? `${data.video_url}&rel=0` : `${data.video_url}?rel=0`;
                htmlContent += `
                    <div id="media-placeholder" class="mb-8 md:mb-12 relative z-20">
                        <div class="relative w-full aspect-video bg-black rounded-2xl md:rounded-3xl overflow-hidden shadow-2xl border border-white/10 group ring-1 ring-white/5">
                            <iframe class="w-full h-full absolute inset-0" src="${embedUrl}" title="${data.title}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        </div>
                    </div>`;
            }

            if (data.text_content) {
                htmlContent += `<div class="prose prose-invert prose-base md:prose-lg max-w-none text-gray-300 leading-relaxed relative z-20">${data.text_content.replace(/\n/g, '<br>')}</div>`;
            }

            if (data.quiz) {
                htmlContent += renderQuizSection(data.quiz);
            }

            htmlContent += `</div>`;
            container.innerHTML = htmlContent;
            feather.replace();
            scrollArea.scrollTop = 0;

        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="text-center text-red-400 py-20 bg-[#16181D] rounded-3xl border border-dashed border-white/10">Gagal memuat materi.</div>`;
        } finally {
            loader.classList.add('hidden');
        }
    }

    function renderQuizSection(quiz) {
        let html = `<div class="mt-20 pt-10 border-t border-dashed border-white/10 relative z-20">`;
        html += `
            <div class="bg-[#16181D] border border-white/5 rounded-3xl p-6 md:p-8 relative overflow-hidden">
                <div class="flex items-center mb-6 relative z-10">
                    <div class="p-3 bg-purple-500/10 text-purple-400 rounded-xl border border-purple-500/20 mr-4">
                        <i data-feather="help-circle" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white">Kuis: ${quiz.title}</h3>
                        <p class="text-sm text-gray-500">${quiz.description || 'Uji pemahaman Anda.'}</p>
                    </div>
                </div>`;

        if (quiz.is_completed) {
            let scoreColor = quiz.score >= 70 ? 'text-green-400 border-green-500/20 bg-green-500/5' : 'text-orange-400 border-orange-500/20 bg-orange-500/5';
            html += `
                <div class="p-8 rounded-2xl border ${scoreColor} text-center relative z-10">
                    <p class="text-xs font-bold uppercase tracking-widest opacity-70 mb-2">Nilai Anda</p>
                    <span class="text-6xl md:text-7xl font-black tracking-tighter">${Math.round(quiz.score)}</span>
                    <span class="text-xl font-bold opacity-60">/ 100</span>
                </div>`;
        } else {
            html += `<form id="quiz-submission-form" onsubmit="submitQuiz(event, '${quiz.id}')" class="space-y-6 relative z-10">`;
            quiz.questions.forEach((q, index) => {
                html += `
                    <div class="bg-[#0F1115] border border-white/5 p-4 md:p-6 rounded-2xl shadow-inner">
                        <p class="font-bold text-gray-200 mb-4 flex gap-4 text-base md:text-lg items-start">
                            <span class="bg-[#252A33] text-gray-400 w-8 h-8 rounded-lg text-sm flex items-center justify-center font-mono border border-white/5 flex-shrink-0">${index + 1}</span>
                            ${q.text}
                        </p>
                        <div class="space-y-3 pl-0 md:pl-12">`;
                q.options.forEach(opt => {
                    if(opt.val) {
                        html += `
                            <label class="flex items-center space-x-4 p-4 rounded-xl border border-white/5 bg-[#1A1D24] hover:bg-purple-500/10 hover:border-purple-500/30 cursor-pointer transition-all group">
                                <input type="radio" name="answers[${q.id}]" value="${opt.key}" required class="w-5 h-5 flex-shrink-0 text-purple-600 focus:ring-purple-500 bg-[#0F1115] border-gray-600">
                                <span class="text-sm text-gray-400 group-hover:text-purple-300 transition-colors font-medium">${opt.val}</span>
                            </label>`;
                    }
                });
                html += `</div></div>`;
            });
            html += `
                <div class="flex justify-end pt-6">
                    <button type="submit" id="btn-submit-quiz" class="w-full md:w-auto px-8 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl shadow-lg shadow-purple-600/20 transition-all transform hover:-translate-y-1">
                        Kirim Jawaban
                    </button>
                </div>
            </form>`;
        }
        html += `</div></div>`;
        return html;
    }

    // Logic submitQuiz dan Chat Script tetap sama seperti sebelumnya...
    // (Copy paste logic submitQuiz dan chat script di sini)
    // ...

    // JS for Chat Logic (Shortened for brevity as logic is same)
    const chatInput = document.getElementById('quick-message-input');
    const sendBtn = document.getElementById('btn-quick-send');
    const quickChatForm = document.getElementById('quick-chat-form');

    if (quickChatForm) {
        quickChatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;
            const originalIcon = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;
            const formData = new FormData(this);
            const chatDestSelect = document.getElementById('chat-destination');
            const mode = chatDestSelect ? chatDestSelect.value : 'public';

            let targetUrl = (mode === 'private') ? "{% url 'send_private_msg_ajax' %}" : "{% url 'send_chat_ajax' %}";
            if (mode === 'private') {
                const lecturerId = document.getElementById('lecturer-id').value;
                if(!lecturerId) { alert('Data dosen error'); return; }
                formData.append('receiver_id', lecturerId);
            }

            try {
                const response = await fetch(targetUrl, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                const data = await response.json();
                if (data.status === 'success') chatInput.value = '';
                else alert('Gagal: ' + data.message);
            } catch (error) { console.error(error); }
            finally { sendBtn.disabled = false; sendBtn.innerHTML = originalIcon; feather.replace(); }
        });
    }
</script>
{% endblock %}