{% extends 'base.html' %}
{% load static %}

{% block title %}{{ module.title }}{% endblock %}

{% block header_title %}{% endblock %}
{% block header_subtitle %}{% endblock %}
{% block navbar_actions %}{% endblock %}
{% block sidebar_menu %}{% endblock %}

{% block content %}
<style>
    aside.w-64 { display: none !important; }
    header { display: none !important; }
    main { 
        padding: 0 !important; 
        width: 100%; 
        background-color: #f3f4f6; 
        height: 100vh; 
        overflow-y: auto; 
    }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="min-h-screen bg-gray-100 font-sans pb-20">

    <div class="bg-[#2a2b3d] text-white pt-6 pb-24 px-6 md:px-12 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-96 h-96 bg-indigo-500/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

        <div class="max-w-7xl mx-auto flex justify-between items-center mb-8 relative z-10">
            <a href="{% url 'mahasiswa_dashboard' %}" class="group flex items-center text-sm font-bold text-gray-300 hover:text-white transition-colors">
                <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center mr-3 group-hover:bg-white/20 transition-all border border-white/5">
                    <i data-feather="arrow-left" class="w-5 h-5"></i>
                </div>
                <span>Kembali ke Dashboard</span>
            </a>
            <div class="flex items-center space-x-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-bold text-white leading-tight">{{ request.session.name }}</p>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mt-0.5">Mahasiswa</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-white font-bold shadow-lg border-2 border-white/10">
                    {{ request.session.name|slice:":1" }}
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto relative z-10">
            <div class="flex items-center space-x-2 text-gray-400 text-xs font-bold uppercase tracking-wider mb-4">
                <span class="bg-white/10 px-2 py-1 rounded text-indigo-200">Course</span>
                <i data-feather="chevron-right" class="w-3 h-3"></i>
                <span class="text-white">{{ module.course.course_name }}</span>
            </div>
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div>
                    <h1 class="text-3xl md:text-4xl font-extrabold mb-3 leading-tight">{{ module.title }}</h1>
                    <div class="flex items-center flex-wrap gap-4 text-sm text-gray-300">
                        <div class="flex items-center bg-white/5 px-3 py-1.5 rounded-lg border border-white/10">
                            <div class="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-[10px] font-bold mr-2">
                                {{ module.course.lecturer.name|slice:":1" }}
                            </div>
                            <span>{{ module.course.lecturer.name }}</span>
                        </div>
                        <span class="flex items-center"><i data-feather="book-open" class="w-4 h-4 mr-2 text-orange-400"></i> {{ contents.count }} Materi</span>
                        <span class="flex items-center"><i data-feather="clipboard" class="w-4 h-4 mr-2 text-blue-400"></i> Tugas: {% if assignment %}Ada{% else %}Tidak ada{% endif %}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 -mt-16 relative z-20">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[600px] border border-gray-100">

            <div class="w-full md:w-80 lg:w-96 border-r border-gray-100 flex flex-col bg-white flex-shrink-0">
                <div class="p-5 border-b border-gray-100 bg-orange-50/50">
                    <h3 class="font-bold text-orange-600 text-sm uppercase tracking-wider mb-1">Daftar Materi</h3>
                    <p class="text-xs text-gray-500 mt-1 font-medium">{{ contents.count }} Halaman Pembelajaran</p>
                </div>
                <div class="flex-1 overflow-y-auto custom-scroll">
                    {% for content in contents %}
                    <button onclick="loadContent('{{ content.content_id }}', this)" id="nav-item-{{ content.content_id }}"
                            class="w-full text-left p-4 flex items-start space-x-3 hover:bg-gray-50 transition-all border-b border-gray-50 relative group
                        {% if forloop.first %}bg-orange-50 border-l-4 border-l-orange-500 active-item{% else %}border-l-4 border-l-transparent{% endif %}">
                        <div class="flex-shrink-0 mt-0.5">
                            {% if content.video_url %}
                            <div class="w-8 h-8 rounded-full bg-white border border-gray-200 text-gray-400 flex items-center justify-center group-hover:text-orange-500 group-hover:border-orange-300 transition-colors shadow-sm">
                                <i data-feather="play" class="w-3 h-3 ml-0.5"></i>
                            </div>
                            {% else %}
                            <div class="w-8 h-8 rounded-full bg-white border border-gray-200 text-gray-400 flex items-center justify-center group-hover:text-blue-500 group-hover:border-blue-300 transition-colors shadow-sm">
                                <i data-feather="file-text" class="w-3 h-3"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-gray-700 group-hover:text-gray-900 leading-snug">{{ content.title }}</h4>
                            <p class="text-[10px] text-gray-400 mt-1 flex items-center">
                                <i data-feather="clock" class="w-3 h-3 mr-1"></i> Pelajari
                            </p>
                        </div>
                    </button>
                    {% empty %}
                    <div class="p-8 text-center text-gray-400 text-sm">Belum ada materi.</div>
                    {% endfor %}
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-white relative min-w-0">
                
                <div id="loading-overlay" class="hidden absolute inset-0 bg-white z-30 flex flex-col items-center justify-center">
                    <div class="w-12 h-12 border-4 border-orange-200 border-t-orange-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-500 font-medium">Memuat materi...</p>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll p-6 md:p-10 relative" id="main-scroll-area">
                    
                    <div id="dynamic-lesson-content">
                        {% with first=contents|first %}
                        {% if first %}
                        <div class="animate-fade-in">
                            <div class="mb-6 pb-6 border-b border-gray-100 flex justify-between items-center">
                                <div>
                                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Topik Bahasan</span>
                                    <h2 class="text-2xl font-bold text-gray-800 mt-1">{{ first.title }}</h2>
                                </div>
                            </div>

                            <div id="media-placeholder" class="mb-8">
                                {% if first.video_url %}
                                <div class="relative w-full aspect-video bg-black rounded-2xl overflow-hidden shadow-lg border border-gray-100 group">
                                    <iframe class="w-full h-full" src="{{ first.get_embed_url }}" title="{{ first.title }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                                </div>
                                {% endif %}
                            </div>

                            <div class="prose prose-orange max-w-none text-gray-600 leading-relaxed">
                                {{ first.text_content|linebreaks }}
                            </div>
                        </div>
                        {% else %}
                        <div class="h-full flex flex-col items-center justify-center text-center py-20">
                            <img src="https://cdni.iconscout.com/illustration/premium/thumb/empty-state-2130362-1800926.png" class="w-64 opacity-50 mb-4" alt="Empty">
                            <h3 class="text-xl font-bold text-gray-400">Belum ada materi yang dipilih</h3>
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>

                    {% if assignment %}
                    <div class="mt-16 pt-10 border-t-2 border-dashed border-gray-200">
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center mr-4">
                                <i data-feather="clipboard" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Tugas Modul</h3>
                                <p class="text-sm text-gray-500">Kerjakan tugas ini untuk menyelesaikan modul</p>
                            </div>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-6">
                            <h4 class="font-bold text-lg text-gray-800 mb-2">{{ assignment.title }}</h4>
                            <p class="text-gray-600 mb-4 text-sm leading-relaxed">{{ assignment.description|linebreaks }}</p>
                            <div class="flex items-center text-xs font-bold text-red-500 bg-red-50 px-3 py-2 rounded-lg w-fit">
                                <i data-feather="clock" class="w-3 h-3 mr-2"></i>
                                Deadline: {{ assignment.deadline|date:"d M Y, H:i" }}
                            </div>
                        </div>

                        {% if submission %}
                            <div class="bg-green-50 border border-green-200 rounded-2xl p-6 flex flex-col md:flex-row gap-6 items-start">
                                <div class="flex-1">
                                    <div class="flex items-center text-green-700 font-bold mb-2">
                                        <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                                        Status: Sudah Dikumpulkan
                                    </div>
                                    <p class="text-xs text-gray-500 mb-4">Dikirim pada: {{ submission.submitted_at|date:"d M Y, H:i" }}</p>
                                    
                                    {% if submission.answer_text %}
                                    <div class="bg-white p-3 rounded-xl border border-green-100 text-sm text-gray-600 mb-3">
                                        <span class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Jawaban Teks:</span>
                                        {{ submission.answer_text }}
                                    </div>
                                    {% endif %}

                                    {% if submission.file_url %}
                                    <a href="{{ submission.file_url }}" target="_blank" class="inline-flex items-center px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-50 hover:text-indigo-600 transition-all">
                                        <i data-feather="file" class="w-4 h-4 mr-2"></i> Download File Jawaban
                                    </a>
                                    {% endif %}

                                    {% if grade.feedback %}
                                    <div class="mt-4 bg-white/80 p-4 rounded-xl border border-green-200 shadow-sm">
                                        <h5 class="text-xs font-bold text-green-700 uppercase mb-2 flex items-center">
                                            <i data-feather="message-circle" class="w-4 h-4 mr-2"></i> Review & Feedback Dosen
                                        </h5>
                                        <div class="text-sm text-gray-700 bg-green-50 p-3 rounded-lg italic border border-green-100">
                                            "{{ grade.feedback|linebreaksbr }}"
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                {% if grade %}
                                <div class="bg-white p-4 rounded-xl border border-gray-200 text-center min-w-[120px]">
                                    <span class="block text-xs font-bold text-gray-400 uppercase">Nilai Anda</span>
                                    <span class="block text-4xl font-extrabold text-indigo-600 mt-1">{{ grade.score|floatformat:0 }}</span>
                                    <span class="block text-[10px] text-gray-400 font-bold mt-1">/ 100</span>
                                </div>
                                {% else %}
                                <div class="bg-white/50 p-4 rounded-xl border border-dashed border-gray-300 text-center min-w-[120px]">
                                    <span class="block text-xs font-bold text-gray-400 uppercase">Nilai</span>
                                    <span class="block text-sm font-bold text-gray-500 mt-2">Belum Dinilai</span>
                                </div>
                                {% endif %}
                            </div>

                        {% else %}
                            <form method="POST" enctype="multipart/form-data" class="bg-gray-50 border border-gray-200 rounded-2xl p-6">
                                {% csrf_token %}
                                <h4 class="font-bold text-gray-700 mb-4 text-sm uppercase tracking-wide">Form Pengumpulan</h4>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-bold text-gray-600 mb-2">Jawaban Teks</label>
                                    <textarea name="answer_text" rows="3" class="w-full border border-gray-300 rounded-xl p-3 text-sm focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="Tulis jawaban singkat di sini..."></textarea>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="block text-sm font-bold text-gray-600 mb-2">Upload File</label>
                                    <input type="file" name="assignment_file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-white file:text-indigo-700 hover:file:bg-indigo-50 cursor-pointer border border-gray-300 rounded-xl bg-white">
                                </div>

                                <div class="flex justify-end">
                                    <button type="submit" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:-translate-y-0.5 transition-all flex items-center">
                                        <i data-feather="send" class="w-4 h-4 mr-2"></i> Kumpulkan Tugas
                                    </button>
                                </div>
                            </form>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="h-10"></div>
                </div>

                <div class="p-4 border-t border-gray-100 bg-gray-50 sticky bottom-0 z-20 backdrop-blur-md bg-gray-50/90">
    
                    <form id="quick-chat-form" onsubmit="return false;" class="relative flex flex-col gap-2">
                        {% csrf_token %}
                        
                        <input type="hidden" name="course_id" value="{{ module.course.course_id }}">
                        <input type="hidden" id="lecturer-id" value="{{ module.course.lecturer.user_id }}">
                        
                        <div class="flex items-center gap-2">
                            <div class="relative">
                                <select id="chat-destination" class="appearance-none bg-white border border-gray-200 text-gray-700 text-xs font-bold py-3 pl-3 pr-8 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-200 cursor-pointer shadow-sm transition-all hover:border-indigo-300">
                                    <option value="public">ðŸ‘¥ Kelas</option>
                                    {% if module.course.lecturer %}
                                    <option value="private">ðŸ”’ Dosen</option>
                                    {% endif %}
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                    <i data-feather="chevron-down" class="w-3 h-3"></i>
                                </div>
                            </div>

                            <div class="relative flex-1">
                                <input type="text" id="quick-message-input" name="message" 
                                    placeholder="Tanya ke kelas..." 
                                    class="w-full pl-4 pr-12 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 transition-all text-sm shadow-sm"
                                    autocomplete="off" required>
                                
                                <button type="submit" id="btn-quick-send" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all shadow-md active:scale-95">
                                    <i data-feather="send" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="flex justify-between items-center mt-2 px-1">
                        <p class="text-[10px] text-gray-400" id="chat-hint">Pesan akan terlihat oleh semua anggota kelas.</p>
                        <a href="{% url 'chat_room' module.course.course_id %}" class="text-[10px] font-bold text-indigo-500 hover:text-indigo-700 hover:underline tracking-wide flex items-center">
                            BUKA FORUM LENGKAP <i data-feather="external-link" class="w-3 h-3 ml-1"></i>
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    feather.replace();

    // ===========================
    // 1. FUNGSI LOAD MATERI (AJAX)
    // ===========================
    // URL untuk submit quiz
    const urlSubmitQuiz = "{% url 'submit_quiz_ajax' %}";

    async function loadContent(contentId, btnElement) {
        // ... (Kode Reset Style Tombol Sidebar TETAP SAMA seperti sebelumnya) ...
        document.querySelectorAll('button[id^="nav-item-"]').forEach(btn => {
            btn.classList.remove('bg-orange-50', 'border-l-orange-500', 'active-item');
            btn.classList.add('border-l-transparent');
            const iconBox = btn.querySelector('.w-8');
            if(iconBox) {
                iconBox.classList.remove('text-orange-500', 'border-orange-300');
                iconBox.classList.add('text-gray-400', 'border-gray-200');
            }
        });

        if(btnElement) {
            btnElement.classList.remove('border-l-transparent');
            btnElement.classList.add('bg-orange-50', 'border-l-4', 'border-l-orange-500', 'active-item');
            const iconBox = btnElement.querySelector('.w-8');
            if(iconBox) {
                iconBox.classList.remove('text-gray-400', 'border-gray-200');
                iconBox.classList.add('text-orange-500', 'border-orange-300');
            }
        }

        const container = document.getElementById('dynamic-lesson-content');
        const loader = document.getElementById('loading-overlay');
        const scrollArea = document.getElementById('main-scroll-area');
        
        loader.classList.remove('hidden');

        try {
            const response = await fetch(`/api/content/${contentId}/`);
            if (!response.ok) throw new Error('Gagal ambil data');
            const data = await response.json();

            // 1. Render Media & Teks
            let htmlContent = '';
            
            // Header Materi
            htmlContent += `
                <div class="mb-6 pb-6 border-b border-gray-100 flex justify-between items-center">
                    <div>
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Topik Bahasan</span>
                        <h2 class="text-2xl font-bold text-gray-800 mt-1">${data.title}</h2>
                    </div>
                </div>`;

            if (data.video_url) {
                htmlContent += `<div class="relative w-full aspect-video bg-black rounded-2xl overflow-hidden shadow-lg border border-gray-100 mb-8"><iframe class="w-full h-full" src="${data.video_url}" frameborder="0" allowfullscreen></iframe></div>`;
            }
            
            if (data.text_content) {
                htmlContent += `<div class="prose prose-orange max-w-none text-gray-600 leading-relaxed mb-10">${data.text_content.replace(/\n/g, '<br>')}</div>`;
            }

            // 2. Render QUIZ (JIKA ADA)
            if (data.quiz) {
                htmlContent += renderQuizSection(data.quiz);
            }

            container.innerHTML = `<div class="animate-fade-in">${htmlContent}</div>`;
            feather.replace();
            scrollArea.scrollTop = 0;

        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="text-center text-red-500 py-10">Gagal memuat materi.</div>`;
        } finally {
            loader.classList.add('hidden');
        }
    }

    // Helper: Render Tampilan Quiz
    function renderQuizSection(quiz) {
        let html = `<div class="mt-8 pt-8 border-t-2 border-dashed border-gray-200">`;
        
        html += `
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center mr-4">
                    <i data-feather="help-circle" class="w-5 h-5"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-800">Kuis: ${quiz.title}</h3>
                    <p class="text-sm text-gray-500">${quiz.description || 'Kerjakan kuis ini untuk menguji pemahaman Anda.'}</p>
                </div>
            </div>`;

        if (quiz.is_completed) {
            // Tampilan SUDAH Dikerjakan (Nilai)
            let scoreColor = quiz.score >= 70 ? 'text-green-600 bg-green-50 border-green-200' : 'text-orange-600 bg-orange-50 border-orange-200';
            
            html += `
                <div class="p-6 rounded-2xl border ${scoreColor} text-center">
                    <p class="text-sm font-bold uppercase tracking-wider opacity-70 mb-1">Nilai Anda</p>
                    <span class="text-5xl font-extrabold">${Math.round(quiz.score)}</span>
                    <span class="text-xl font-bold opacity-60">/ 100</span>
                    <p class="mt-4 text-sm font-medium opacity-80">Anda sudah mengerjakan kuis ini.</p>
                </div>
            `;
        } else {
            // Tampilan FORM Soal (Belum Dikerjakan)
            html += `<form id="quiz-submission-form" onsubmit="submitQuiz(event, '${quiz.id}')" class="space-y-6">`;
            
            quiz.questions.forEach((q, index) => {
                html += `
                    <div class="bg-white border border-gray-200 p-5 rounded-xl shadow-sm">
                        <p class="font-bold text-gray-800 mb-3 flex gap-2">
                            <span class="bg-gray-100 text-gray-500 px-2 rounded text-sm flex items-center justify-center h-6">${index + 1}</span>
                            ${q.text}
                        </p>
                        <div class="space-y-2 pl-2">
                `;
                
                q.options.forEach(opt => {
                    if(opt.val) { // Hanya render jika opsi tidak kosong
                        html += `
                            <label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-100 hover:bg-purple-50 hover:border-purple-200 cursor-pointer transition-all group">
                                <input type="radio" name="answers[${q.id}]" value="${opt.key}" required class="w-4 h-4 text-purple-600 focus:ring-purple-500 border-gray-300">
                                <span class="text-sm text-gray-600 group-hover:text-purple-700">${opt.val}</span>
                            </label>
                        `;
                    }
                });

                html += `</div></div>`;
            });

            html += `
                <div class="flex justify-end pt-4">
                    <button type="submit" id="btn-submit-quiz" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg shadow-purple-200 transition-all transform hover:-translate-y-1">
                        Kirim Jawaban
                    </button>
                </div>
            </form>`;
        }

        html += `</div>`;
        return html;
    }

    // Fungsi Submit Quiz via AJAX
    async function submitQuiz(event, quizId) {
        event.preventDefault();
        const form = event.target;
        const btn = document.getElementById('btn-submit-quiz');
        const originalText = btn.innerText;

        // UI Loading
        btn.disabled = true;
        btn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin inline-block mr-2"></div> Memproses...`;

        const formData = new FormData(form);
        formData.append('quiz_id', quizId);

        try {
            const response = await fetch(urlSubmitQuiz, {
                method: 'POST',
                body: formData,
                headers: { 
                    'X-Requested-With': 'XMLHttpRequest',
                    // Pastikan CSRF Token terambil
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value 
                }
            });
            const data = await response.json();

            if (data.status === 'success') {
                showToast(`Kuis selesai! Nilai Anda: ${data.score}`, 'success');
                // Reload konten ini untuk menampilkan nilai (bukan form lagi)
                // Kita ambil ID konten dari tombol navigasi yang sedang aktif
                const activeBtn = document.querySelector('.active-item');
                if(activeBtn) {
                    const contentId = activeBtn.id.replace('nav-item-', '');
                    loadContent(contentId, activeBtn);
                }
            } else {
                showToast('Gagal: ' + data.message, 'error');
                btn.disabled = false;
                btn.innerText = originalText;
            }
        } catch (e) {
            console.error(e);
            showToast('Terjadi kesalahan koneksi.', 'error');
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }
    
    // ===========================
    // 2. FUNGSI CHAT (AJAX) - UPDATE
    // ===========================
    // Tambahkan variabel selector elemen baru
    const chatDestSelect = document.getElementById('chat-destination');
    const chatInput = document.getElementById('quick-message-input');
    const chatHint = document.getElementById('chat-hint');
    const sendBtn = document.getElementById('btn-quick-send');

    // 1. Ubah Placeholder & Hint saat dropdown berubah
    if (chatDestSelect) {
        chatDestSelect.addEventListener('change', function() {
            if (this.value === 'private') {
                chatInput.placeholder = "Kirim pesan pribadi ke Dosen...";
                chatInput.classList.replace('focus:ring-indigo-200', 'focus:ring-orange-200'); 
                chatInput.classList.replace('focus:border-indigo-400', 'focus:border-orange-400');
                sendBtn.classList.replace('bg-indigo-600', 'bg-orange-600');
                sendBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-orange-700');
                if(chatHint) chatHint.innerText = "Pesan hanya dapat dibaca oleh Anda dan Dosen.";
            } else {
                chatInput.placeholder = "Tanya ke diskusi kelas...";
                chatInput.classList.replace('focus:ring-orange-200', 'focus:ring-indigo-200');
                chatInput.classList.replace('focus:border-orange-400', 'focus:border-indigo-400');
                sendBtn.classList.replace('bg-orange-600', 'bg-indigo-600');
                sendBtn.classList.replace('hover:bg-orange-700', 'hover:bg-indigo-700');
                if(chatHint) chatHint.innerText = "Pesan akan terlihat oleh semua anggota kelas.";
            }
        });
    }

    const quickChatForm = document.getElementById('quick-chat-form');
    if (quickChatForm) {
        quickChatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;

            // UI Loading
            const originalIcon = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;

            const formData = new FormData(this);
            const mode = chatDestSelect ? chatDestSelect.value : 'public'; // Default public jika dropdown tidak ada
            
            let targetUrl = "";
            let successMsg = "";

            // Tentukan URL Tujuan (Publik vs Privat)
            if (mode === 'private') {
                // Mode Privat: Butuh receiver_id (ID Dosen)
                const lecturerId = document.getElementById('lecturer-id').value;
                if(!lecturerId) {
                    showToast('Gagal: Data dosen tidak ditemukan.', 'error');
                    resetBtn();
                    return;
                }
                formData.append('receiver_id', lecturerId);
                targetUrl = "{% url 'send_private_msg_ajax' %}";
                successMsg = "Pesan terkirim ke Dosen!";
            } else {
                // Mode Publik: Butuh course_id (sudah ada di hidden input form)
                targetUrl = "{% url 'send_chat_ajax' %}";
                successMsg = "Pertanyaan terkirim ke Diskusi Kelas!";
            }

            try {
                const response = await fetch(targetUrl, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();

                if (data.status === 'success') {
                    chatInput.value = '';
                    showToast(successMsg, 'success');
                } else {
                    showToast('Gagal: ' + (data.message || 'Error'), 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('Terjadi kesalahan koneksi.', 'error');
            } finally {
                resetBtn();
            }

            function resetBtn() {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalIcon;
                feather.replace();
            }
        });
    }

    // Helper Toast
    function showToast(message, type) {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'fixed top-24 right-5 z-[100] space-y-2 pointer-events-none';
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
        toast.className = `${bgColor} text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 transform transition-all duration-300 translate-x-full pointer-events-auto min-w-[280px] animate-fade-in`;
        toast.innerHTML = `<span class="font-bold text-xs">${message}</span>`;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
        setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 4000);
    }

    // Inject CSS Animasi
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `.animate-fade-in { animation: fadeIn 0.5s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }`;
    document.head.appendChild(styleSheet);
</script>
{% endblock %}
{% endblock %}